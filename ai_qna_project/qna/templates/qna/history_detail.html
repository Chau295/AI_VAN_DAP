{% extends "base.html" %}
{% load static %}

{% block title %}Kết quả phiên thi #{{ session.id }} — {{ session.subject.name }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6">
  <div class="flex items-start justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">
        Kết quả phiên thi #{{ session.id }} — {{ session.subject.name }}
      </h1>
      <p class="text-sm text-gray-500 mt-1">
        Thí sinh: <span class="font-semibold">{{ session.user.username }}</span>
        {% if session.completed_at %} • Hoàn thành: {{ session.completed_at|date:"d/m/Y H:i" }}{% endif %}
      </p>
    </div>
    <a href="{% url 'history' %}" class="inline-flex items-center px-4 py-2 rounded-lg border text-sm font-semibold hover:bg-gray-50">
      ← Quay lại lịch sử
    </a>
  </div>

  <!-- Tổng kết điểm -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
    <div class="bg-blue-50 p-5 rounded-lg border">
      <div class="text-sm text-gray-600">Điểm phần chính (TB)</div>
      <div class="text-4xl font-extrabold text-blue-600">
        {% if main_avg is not None %}{{ main_avg|floatformat:2 }}{% else %}-{% endif %} / 10
      </div>
    </div>

    <div class="bg-green-50 p-5 rounded-lg border">
      <div class="text-sm text-gray-600">Điểm cộng từ câu phụ</div>
      <div class="text-4xl font-extrabold text-green-600">
        {{ supp_sum|default:0|floatformat:2 }}
      </div>
    </div>

    <div class="bg-indigo-50 p-5 rounded-lg border">
      <div class="text-sm text-gray-600">Tổng điểm cuối (tối đa 10)</div>
      <div class="text-4xl font-extrabold text-indigo-600">
        {{ final_total|default:0|floatformat:2 }} / 10
      </div>
    </div>
  </div>

  <!-- Chi tiết câu hỏi chính -->
  <div class="mb-8">
    <h3 class="text-xl font-bold text-gray-800 mb-4">Chi tiết các câu hỏi chính</h3>

    {% if results %}
      <div class="space-y-3">
        {% for result in results %}
          <div class="p-4 border rounded-lg transition-all hover:shadow-md hover:border-blue-300">
            <div class="flex justify-between items-start gap-4">
              <div class="min-w-0">
                <p class="font-semibold text-gray-800">
                  {{ forloop.counter }}. {{ result.question.question_text }}
                </p>

                {% if result.transcript %}
                <p class="text-sm text-gray-600 mt-2">
                  <span class="font-medium">Bài nói:</span>
                  <span class="italic">{{ result.transcript }}</span>
                </p>
                {% endif %}

                {% if result.feedback %}
                <p class="text-sm text-gray-700 mt-2">
                  <span class="font-medium">Nhận xét:</span> {{ result.feedback }}
                </p>
                {% endif %}

                {% if result.analysis %}
                <div class="mt-2">
                  <div class="text-sm text-gray-500">Phân tích đáp án</div>
                  {% if result.analysis.0 %}
                    <ul class="text-sm list-disc list-inside text-gray-700 mt-1">
                      {% for item in result.analysis %}
                        <li>{{ item }}</li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-sm text-gray-500 mt-1">{{ result.analysis }}</p>
                  {% endif %}
                </div>
                {% endif %}
              </div>

              <div class="flex-shrink-0 text-right">
                <div class="text-xs text-gray-500 mb-1">Điểm</div>
                <div class="text-2xl font-bold text-blue-600">
                  {{ result.score|default:0|floatformat:2 }} / 10
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-gray-500">Chưa có kết quả phần chính.</div>
    {% endif %}
  </div>

  <!-- Câu hỏi phụ -->
  <div class="mb-8">
    <h3 class="text-xl font-bold text-gray-800 mb-4">Chi tiết câu hỏi phụ</h3>

    {% if supp_results %}
      <div class="space-y-3">
        {% for s in supp_results %}
          <div class="p-4 border rounded-lg transition-all hover:shadow-md hover:border-green-300">
            <div class="flex justify-between items-start gap-4">
              <div class="min-w-0">
                <p class="font-semibold text-gray-800">
                  Câu phụ {{ forloop.counter }}. {{ s.question_text }}
                </p>

                {% if s.transcript %}
                <p class="text-sm text-gray-600 mt-2">
                  <span class="font-medium">Bài nói:</span>
                  <span class="italic">{{ s.transcript }}</span>
                </p>
                {% endif %}

                {% if s.feedback %}
                <p class="text-sm text-gray-700 mt-2">
                  <span class="font-medium">Nhận xét:</span> {{ s.feedback }}
                </p>
                {% endif %}

                {% if s.analysis %}
                <div class="mt-2">
                  <div class="text-sm text-gray-500">Phân tích đáp án</div>
                  {% if s.analysis.0 %}
                    <ul class="text-sm list-disc list-inside text-gray-700 mt-1">
                      {% for item in s.analysis %}
                        <li>{{ item }}</li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-sm text-gray-500 mt-1">{{ s.analysis }}</p>
                  {% endif %}
                </div>
                {% endif %}
              </div>

              <div class="flex-shrink-0 text-right">
                <div class="text-xs text-gray-500 mb-1">Điểm cộng</div>
                <div class="text-2xl font-bold text-green-600">
                  +{{ s.score|default:0|floatformat:2 }} / {{ s.max_score|default:0|floatformat:2 }}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-gray-500">Không có câu hỏi phụ.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
