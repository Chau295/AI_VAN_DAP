{% extends "base.html" %}
{% load static %}

{% block title %}Kết quả phiên thi #{{ session.id }} — {{ session.subject.name }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">
        Kết quả phiên thi #{{ session.id }}
      </h1>
      <p class="text-md text-gray-600 mt-1">
        <span class="font-semibold">{{ session.subject.name }}</span> •
        <span class="font-normal">{{ session.user.get_full_name|default:session.user.username }}</span>
      </p>
      <p class="text-sm text-gray-500 mt-1">
        {% if session.completed_at %}Hoàn thành lúc: {{ session.completed_at|date:"H:i, d/m/Y" }}{% else %}Chưa hoàn thành{% endif %}
      </p>
    </div>
    <a href="{% url 'qna:history' %}" class="mt-4 sm:mt-0 inline-flex items-center px-4 py-2 rounded-lg border border-gray-300 text-sm font-semibold bg-white text-gray-700 hover:bg-gray-50 transition-colors shadow-sm">
      <i class="fas fa-arrow-left mr-2"></i>
      Quay lại Lịch sử
    </a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500 text-center transform hover:-translate-y-1 transition-transform duration-300">
      <div class="flex justify-center items-center mx-auto bg-blue-100 rounded-full w-12 h-12 mb-3">
        <i class="fas fa-star text-xl text-blue-600"></i>
      </div>
      <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Điểm Phần Chính</p>
      <p class="text-5xl font-extrabold text-blue-600 my-1">
        {% if main_avg is not None %}{{ main_avg|floatformat:2 }}{% else %}N/A{% endif %}
      </p>
      <p class="text-gray-500 text-sm">(Điểm trung bình / 10)</p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500 text-center transform hover:-translate-y-1 transition-transform duration-300">
      <div class="flex justify-center items-center mx-auto bg-green-100 rounded-full w-12 h-12 mb-3">
        <i class="fas fa-plus text-xl text-green-600"></i>
      </div>
      <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Điểm Cộng</p>
      <p class="text-5xl font-extrabold text-green-600 my-1">
        +{{ supp_sum|default:0|floatformat:2 }}
      </p>
      <p class="text-gray-500 text-sm">(Từ câu hỏi phụ)</p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500 text-center transform hover:-translate-y-1 transition-transform duration-300">
      <div class="flex justify-center items-center mx-auto bg-indigo-100 rounded-full w-12 h-12 mb-3">
        <i class="fas fa-trophy text-xl text-indigo-600"></i>
      </div>
      <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Điểm Cuối Cùng</p>
      <p class="text-5xl font-extrabold text-indigo-600 my-1">
        {{ final_total|default:0|floatformat:2 }}
      </p>
      <p class="text-gray-500 text-sm">(Đã áp dụng giới hạn 7.0)</p>
    </div>
  </div>

  <div class="mb-10">
    <h3 class="text-2xl font-bold text-gray-800 mb-5">Chi tiết câu hỏi chính</h3>
    <div class="space-y-4">
      {% for result in results %}
        <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-blue-400 hover:shadow-lg transition-shadow">
          <div class="flex justify-between items-start gap-4">
            <p class="font-semibold text-gray-800 flex-grow">
              <span class="text-blue-500 font-bold">Câu {{ forloop.counter }}:</span> {{ result.question.question_text }}
            </p>
            <div class="flex-shrink-0 text-right bg-blue-50 px-3 py-1 rounded-full">
              <p class="text-xl font-bold text-blue-700">
                {{ result.score|default:0|floatformat:2 }}<span class="text-sm font-medium text-blue-500">/10</span>
              </p>
            </div>
          </div>
          {% if result.transcript or result.feedback %}
          <div class="mt-4 pt-4 border-t border-gray-200 space-y-3 text-sm">
            {% if result.transcript %}
              <p class="text-gray-700"><i class="fas fa-microphone-alt w-5 text-gray-400 mr-2"></i><span class="font-semibold">Bạn đã trả lời:</span> <em class="text-gray-600">"{{ result.transcript }}"</em></p>
            {% endif %}
            {% if result.feedback %}
              <p class="text-gray-700"><i class="fas fa-comment-dots w-5 text-gray-400 mr-2"></i><span class="font-semibold">Nhận xét từ AI:</span> {{ result.feedback }}</p>
            {% endif %}
          </div>
          {% endif %}
        </div>
      {% empty %}
        <div class="text-center text-gray-500 bg-gray-50 p-6 rounded-lg">Chưa có kết quả nào cho phần câu hỏi chính.</div>
      {% endfor %}
    </div>
  </div>

  <div>
    <h3 class="text-2xl font-bold text-gray-800 mb-5">Chi tiết câu hỏi phụ</h3>
    <div class="space-y-4">
      {% for result in supp_results %}
        <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-green-400 hover:shadow-lg transition-shadow">
          <div class="flex justify-between items-start gap-4">
            <p class="font-semibold text-gray-800 flex-grow">
              <span class="text-green-600 font-bold">Câu phụ {{ forloop.counter }}:</span> {{ result.question_text }}
            </p>
            <div class="flex-shrink-0 text-right bg-green-50 px-3 py-1 rounded-full">
              <p class="text-xl font-bold text-green-700">
                +{{ result.score|default:0|floatformat:2 }}<span class="text-sm font-medium text-green-500">/{{ result.max_score|floatformat:1 }}</span>
              </p>
            </div>
          </div>
          {% if result.transcript or result.feedback %}
          <div class="mt-4 pt-4 border-t border-gray-200 space-y-3 text-sm">
             {% if result.transcript %}
              <p class="text-gray-700"><i class="fas fa-microphone-alt w-5 text-gray-400 mr-2"></i><span class="font-semibold">Bạn đã trả lời:</span> <em class="text-gray-600">"{{ result.transcript }}"</em></p>
            {% endif %}
            {% if result.feedback %}
              <p class="text-gray-700"><i class="fas fa-comment-dots w-5 text-gray-400 mr-2"></i><span class="font-semibold">Nhận xét từ AI:</span> {{ result.feedback }}</p>
            {% endif %}
          </div>
          {% endif %}
        </div>
      {% empty %}
        <div class="text-center text-gray-500 bg-gray-50 p-6 rounded-lg">Không có câu hỏi phụ nào được trả lời.</div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}