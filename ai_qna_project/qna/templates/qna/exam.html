{% extends 'base.html' %}
{% load static %}

{% block title %}Bài thi: {{ subject.name }}{% endblock %}

{% block content %}
<div id="exam-container" class="h-full">
  <div id="question-selection-area">
    <div class="bg-white p-8 rounded-xl shadow-md max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <div>
          <h2 class="text-3xl font-bold text-gray-800">Phần câu hỏi chính</h2>
          <p class="text-gray-500">Vui lòng chọn lần lượt các câu hỏi để trả lời.</p>
        </div>
        <div>
          <h3 class="text-md font-semibold text-gray-700 text-right">Tổng thời gian còn lại</h3>
          <div id="main-timer" class="mt-1 text-3xl font-mono bg-red-100 text-red-700 text-center py-2 px-4 rounded-lg">15:00</div>
        </div>
      </div>

      <div id="question-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-auto pr-1">
        {% for question in selected_questions %}
        <button
          class="question-choice-btn w-full h-full text-left p-5 bg-white rounded-xl border border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all focus:outline-none flex flex-col justify-between"
          data-question-id="{{ question.id }}"
          data-question-text="{{ question.question_text }}">
          <div class="flex items-start justify-between gap-2">
            <span class="font-semibold text-base text-gray-800">Câu hỏi {{ forloop.counter }}</span>
            <span class="q-status inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600">Chưa trả lời</span>
          </div>
          <p class="text-gray-600 mt-3 line-clamp-3">{{ question.question_text }}</p>
        </button>
        {% empty %}
        <div class="text-center text-gray-600">Không có câu hỏi chính nào.</div>
        {% endfor %}
      </div>

      <div class="mt-8 pt-6 border-t flex justify-end items-center">
        <button id="finish-exam-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
          <i class="fas fa-flag-checkered mr-2"></i>Kết thúc phần chính
        </button>
      </div>
    </div>
  </div>

  <div id="answer-area" class="h-full hidden">
    <div class="bg-white shadow-2xl rounded-2xl flex flex-col md:flex-row overflow-hidden h-full">
      <div class="w-full md:w-2/5 bg-gray-50 border-r border-gray-200 p-6 flex flex-col">
        <h2 id="answer-area-title" class="text-xl font-bold text-gray-800">Bài thi: {{ subject.name }}</h2>
        <p id="answer-area-question" class="mt-2 text-gray-600 bg-gray-100 p-4 rounded-lg min-h-[100px]"></p>
        <div class="flex-shrink-0 mt-auto pt-6">
          <button id="back-to-selection-btn" class="w-full text-center block bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Quay về danh sách
          </button>
        </div>
      </div>

      <div class="w-full md:w-3/5 p-8 flex flex-col items-center justify-center text-center bg-white">
        <div id="interaction-state">
          <i class="fas fa-microphone-alt text-5xl text-gray-300"></i>
          <h2 class="text-2xl font-bold text-gray-800 mt-4">Sẵn sàng trả lời</h2>
          <p class="text-gray-500 mt-2">Nhấn nút bên dưới để bắt đầu ghi âm.</p>
          <button id="start-recording-btn" class="mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-all text-lg shadow-lg">
            <i class="fas fa-play mr-2"></i> Bắt đầu
          </button>
        </div>

        <div id="recording-state" class="hidden w-full">
          <h2 class="text-2xl font-bold text-blue-600 mt-4">Đang ghi âm...</h2>
          <p class="text-gray-500 mt-2">Hãy nói rõ ràng. Nhấn Dừng để nộp bài.</p>
          <button id="stop-recording-btn" class="mt-8 bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition-all text-lg shadow-lg">
            <i class="fas fa-stop mr-2"></i> Dừng & Nộp bài
          </button>
        </div>

        <div id="grading-state" class="hidden">
          <i class="fas fa-spinner fa-spin text-5xl text-gray-400"></i>
          <h2 class="text-2xl font-bold text-gray-800 mt-4">Đang chấm điểm...</h2>
        </div>
      </div>
    </div>
  </div>

  <div id="suppSticky" style="display:none; position:fixed; right:16px; bottom:16px; z-index:9998;">
    <div style="background:#111827; color:#fff; padding:8px 12px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2)">
      Câu hỏi phụ còn: <span id="suppStickyTimer" class="font-mono font-bold">06:00</span>
    </div>
  </div>

  <div id="summaryModal" class="modal" style="display:none;">
      <div class="modal-content w-full max-w-lg bg-white rounded-xl shadow-2xl flex flex-col m-4">
          <div class="p-6 border-b border-gray-200">
              <h3 class="text-2xl font-bold text-gray-800">Kết quả phần thi chính</h3>
          </div>
          <div class="p-8 flex-grow text-center">
              <p class="text-gray-600 mb-2">Điểm trung bình hiện tại của bạn là:</p>
              <div id="summaryScore" class="text-6xl font-extrabold text-gray-900 leading-none">0.00</div>
              <div id="summaryNote" class="mt-4 text-gray-700 bg-gray-50 p-4 rounded-lg"></div>

              <div id="suppCountdownWrap" class="mt-6 rounded-lg bg-yellow-50 border border-yellow-200 p-4" style="display:none;">
                  <div class="font-semibold text-yellow-800 mb-1">Thời gian còn lại để bắt đầu câu hỏi phụ</div>
                  <div id="suppCountdown" class="font-mono text-2xl font-bold text-yellow-900">06:00</div>
              </div>
          </div>
          <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-xl flex items-center justify-end gap-3">
              <button id="btnSummaryExit" class="btn">Đóng</button>
              <button id="btnStartSupp" class="btn btn-primary" style="display:none;">Bắt đầu thi câu hỏi phụ</button>
          </div>
      </div>
  </div>

  <div id="finalResultModal" class="modal" style="display:none;">
      <div class="modal-content w-full max-w-5xl bg-white rounded-xl shadow-2xl flex flex-col h-[90vh] max-h-[800px] m-4">
          <div class="p-6 border-b border-gray-200 flex-shrink-0">
              <h3 class="text-2xl font-bold text-gray-800">Kết quả chi tiết</h3>
          </div>
          <div class="flex-grow overflow-y-auto p-2 sm:p-6">
              <div class="grid gap-8 lg:grid-cols-3">
                  <div class="lg:col-span-2 space-y-4">
                      <div>
                          <h4 class="text-xl font-semibold text-gray-700 mb-4 px-2 sm:px-0">Phần câu hỏi chính</h4>
                          <div id="detailMain" class="space-y-4">
                             </div>
                      </div>

                      <div id="detailSuppWrap" class="mt-8" style="display:none;">
                          <h4 class="text-xl font-semibold text-gray-700 mb-4 px-2 sm:px-0">Phần câu hỏi phụ</h4>
                          <div id="detailSupp" class="space-y-4"></div>
                      </div>
                  </div>
                  <div class="lg:col-span-1">
                      <div class="sticky top-0 p-1">
                          <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                              <div class="text-sm font-medium text-gray-600 mb-1">Tổng điểm cuối cùng</div>
                              <div class="text-5xl font-extrabold text-blue-600 leading-none">
                                  <span id="finalTotalScore">0.00</span><span class="text-gray-400 text-2xl">/7</span>
                              </div>
                              <div class="mt-6 border-t pt-4">
                                  <div id="appealTimer">
                                      <div class="text-sm font-medium text-gray-600">Thời gian phúc khảo còn lại:</div>
                                      <div id="appealCountdown" class="font-mono text-2xl font-bold text-indigo-600 mt-1">06:00</div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-xl flex-shrink-0 flex items-center justify-end">
              <button id="btnFinishAll" class="btn btn-primary">Hoàn thành và về trang chủ</button>
          </div>
      </div>
  </div>

  <div id="answerDetailModal" class="modal" style="display:none;">
      <div class="modal-content w-full max-w-4xl bg-white rounded-xl shadow-2xl flex flex-col h-[90vh] max-h-[800px] m-4">
          <div class="p-6 border-b border-gray-200 flex-shrink-0">
              <h3 id="detailTitle" class="text-2xl font-bold text-gray-800">Chi tiết câu trả lời</h3>
          </div>

          <div class="p-6 flex-grow overflow-y-auto space-y-4">
              <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="text-sm text-gray-500">Câu hỏi</div>
                  <div id="detailQuestion" class="mt-1 font-semibold text-gray-800"></div>
              </div>

              <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="text-sm text-gray-500">Câu trả lời của bạn (gỡ băng)</div>
                  <div id="detailTranscript" class="mt-1 text-gray-800 italic"></div>
              </div>

              <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="text-sm text-gray-500">Nhận xét</div>
                  <div id="detailFeedback" class="mt-1 text-gray-800"></div>
              </div>

              <div id="detailAnalysisBlock" class="bg-gray-50 p-4 rounded-lg border" style="display:none;">
                  <div class="text-sm text-gray-500">Phân tích đáp án</div>
                  <ul id="detailAnalysis" class="mt-2 list-disc list-inside text-gray-800"></ul>
              </div>

              <div class="bg-gray-50 p-4 rounded-lg border flex items-center justify-between">
                  <div class="text-sm text-gray-500">Điểm</div>
                  <div>
                      <span id="detailScore" class="text-2xl font-bold text-blue-600">0.00</span>
                      <span id="detailMax" class="text-gray-500"></span>
                  </div>
              </div>

              <div id="appealFormBlock" class="bg-yellow-50 p-5 rounded-lg border border-yellow-200 mt-2">
                  <h4 class="text-lg font-semibold text-yellow-800 mb-2">Xin phúc khảo</h4>
                  <label for="appealReason" class="text-sm text-gray-700">Lý do phúc khảo (tối đa 300 ký tự)</label>
                  <textarea id="appealReason" class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-yellow-400" rows="3" maxlength="300" placeholder="Trình bày rõ ràng lý do bạn cho rằng câu trả lời xứng đáng điểm cao hơn..."></textarea>
                  <div class="mt-1 text-xs text-gray-500 text-right"><span id="appealCount">0</span>/300</div>
              </div>
          </div>

          <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-xl flex-shrink-0 flex items-center justify-end gap-3">
              <button id="btnCloseDetail" class="btn">Đóng</button>
              <button id="btnSubmitAppeal" class="btn btn-primary">Gửi phúc khảo</button>
          </div>
      </div>
  </div>

</div>

{{ session.id|json_script:"session_id_data" }}
{% csrf_token %}

<style>
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(17, 24, 39, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }
  .modal-content { }
  .btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: #fff;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }
  .btn:hover { border-color: #9ca3af; background: #f9fafb; }
  .btn-primary { border-color: #2563eb; background: #2563eb; color: #fff; }
  .btn-primary:hover { background: #1d4ed8; border-color: #1d4ed8; }
  .btn-sm { padding: 6px 12px; font-size: 0.875rem; border-radius: 6px; }
  .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
  .line-clamp-2{ overflow:hidden; display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:2; }
  .line-clamp-3{ overflow:hidden; display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:3; }
  #finalResultModal .overflow-y-auto::-webkit-scrollbar,
  #answerDetailModal .overflow-y-auto::-webkit-scrollbar { width: 8px; }
  #finalResultModal .overflow-y-auto::-webkit-scrollbar-track,
  #answerDetailModal .overflow-y-auto::-webkit-scrollbar-track { background: transparent; }
  #finalResultModal .overflow-y-auto::-webkit-scrollbar-thumb,
  #answerDetailModal .overflow-y-auto::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
  #finalResultModal .overflow-y-auto::-webkit-scrollbar-thumb:hover,
  #answerDetailModal .overflow-y-auto::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
</style>
{% endblock %}

{% block extra_js %}
<script>
  window.__BAREM__ = {{ barem_json|default:"[]"|safe }};
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ============== Config ============== */
  const MAIN_DURATION_MS = 15 * 60 * 1000;
  const SUPP_WINDOW_MS   = 6  * 60 * 1000;
  const APPEAL_WINDOW_MS = 6  * 60 * 1000;
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const API_SAVE_SUPP = "/api/save_supplementary_result/";

  /* ============== Elements & State ============== */
  const elements = {
    sessionId: JSON.parse(document.getElementById('session_id_data').textContent),
    selection: document.getElementById('question-selection-area'),
    answer: document.getElementById('answer-area'),
    backBtn: document.getElementById('back-to-selection-btn'),
    startBtn: document.getElementById('start-recording-btn'),
    stopBtn: document.getElementById('stop-recording-btn'),
    interaction: document.getElementById('interaction-state'),
    recording: document.getElementById('recording-state'),
    grading: document.getElementById('grading-state'),
    aTitle: document.getElementById('answer-area-title'),
    aQuestion: document.getElementById('answer-area-question'),
  };

  const examState = { questions: [], currentQuestion: null };
  const state = {
    mainResults: [],
    suppResults: [],
    totalScoreMain: 0,
    totalScoreFinal: 0,
    suppDeadline: null,
    appealDeadline: null,
    suppInProgress: false,
    suppQueue: [],
    currentSuppIndex: -1,
    eachSuppMax: 1.0,   // ✅ mỗi câu phụ luôn tối đa 1.0 điểm (hiển thị/lưu REST)
    appealContext: null
  };

  document.querySelectorAll('.question-choice-btn').forEach(btn => {
    examState.questions.push({
      id: Number(btn.dataset.questionId),
      question_text: btn.dataset.questionText
    });
  });

  /* ============== Utils ============== */
  function modalShow(id){ document.getElementById(id).style.display='flex'; }
  function modalHide(id){ document.getElementById(id).style.display='none'; }
  function fmt(n){ return (Math.round(Number(n||0)*100)/100).toFixed(2); }
  function mmss(ms){ const s=Math.max(0,Math.ceil(ms/1000)); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
  function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

  async function postJSON(url, data){
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
      body: JSON.stringify(data)
    });
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  }
  async function persistSupplementaryItem(r){
    if(r._saved) return;
    try{
      const data = await postJSON(API_SAVE_SUPP, {
        session_id: elements.sessionId,
        question_text: r.question_text,
        transcript: r.transcript,
        score: r.score,          // 0..1
        max_score: 1.0,          // ✅ lưu thang 1.0 cố định
        feedback: r.feedback,
        analysis: r.analysis
      });
      r._saved = true;
      r._id = data && data.supplementary_result_id;
    }catch(e){ console.error('persistSupplementaryItem failed', e); }
  }

  /* ============== Timers ============== */
  let mainTimerEnd=null, mainTimerItv=null;
  function startMainTimer(ms=MAIN_DURATION_MS){
    mainTimerEnd = Date.now() + ms;
    clearInterval(mainTimerItv);
    const el = document.getElementById('main-timer');
    const tick = () => {
      const left = Math.max(0, mainTimerEnd - Date.now());
      el.textContent = mmss(left);
      if (left<=0){ clearInterval(mainTimerItv); onFinishMainExam(); }
    };
    mainTimerItv = setInterval(tick, 250); tick();
  }

  let suppItv=null, appealItv=null;
  function startSuppCountdown(){
    stopSuppCountdown();
    document.getElementById('suppCountdownWrap').style.display = 'block';
    document.getElementById('suppSticky').style.display = 'block';
    suppItv = setInterval(()=>{
      const left = state.suppDeadline - Date.now();
      document.getElementById('suppCountdown').textContent = mmss(left);
      document.getElementById('suppStickyTimer').textContent = mmss(left);
      if (left<=0){ finalizeAndShowResult(); }
    }, 250);
  }
  function stopSuppCountdown(){ if(suppItv){ clearInterval(suppItv); suppItv=null; } }

  function startAppealCountdown(){
    stopAppealCountdown();
    state.appealDeadline = Date.now() + APPEAL_WINDOW_MS;
    appealItv = setInterval(()=>{
      const left = state.appealDeadline - Date.now();
      document.getElementById('appealCountdown').textContent = mmss(left);
      if(left<=0) stopAppealCountdown();
    }, 250);
  }
  function stopAppealCountdown(){ if(appealItv){ clearInterval(appealItv); appealItv=null; } }

  /* ============== Screen / UI ============== */
  function showScreen(name){
    elements.selection.style.display = (name==='selection') ? 'block' : 'none';
    elements.answer.style.display    = (name==='answer') ? 'block' : 'none';
  }
  function setAnswerUI(which){
    ['interaction','recording','grading'].forEach(k => elements[k].style.display='none');
    elements[which].style.display='block';
  }
  function startAnswering(questionData, type, idx=-1){
    examState.currentQuestion = { ...questionData, type };
    if (type==='supplementary'){
      state.currentSuppIndex = idx;
      elements.aTitle.textContent = `Câu hỏi phụ ${idx+1}`;
      elements.backBtn.style.display = 'none';
    } else {
      elements.aTitle.textContent = 'Câu hỏi chính';
      elements.backBtn.style.display = 'block';
    }
    elements.aQuestion.textContent = questionData.question_text;
    setAnswerUI('interaction');
    showScreen('answer');
  }

  /* ============== Audio & WebSocket ============== */
  let socket, mediaRecorder, chunks=[];
  function connectWS(){
    try{
      const wsScheme = location.protocol==='https:' ? 'wss' : 'ws';
      socket = new WebSocket(`${wsScheme}://${location.host}/ws/exam/{{ session.id }}/`);
      socket.binaryType = "arraybuffer";
      socket.onopen = () => console.log('WS connected');
      socket.onmessage = evt => {
        try{
          const m = JSON.parse(evt.data);
          if(m.type==='exam.result' && m.message) handleExamResult(m.message);
          else if(m.type==='exam.error') { alert(m.message||'Lỗi'); setAnswerUI('interaction'); }
        }catch(_){}
      };
      socket.onclose = () => console.warn('WS closed');
      socket.onerror = () => console.warn('WS error');
    }catch(e){ console.warn('Cannot init WS', e); }
  }

  async function startRecording(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
      });
      chunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType:'audio/webm;codecs=opus' });
      mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type:'audio/webm;codecs=opus' });
        if(examState.currentQuestion?.type==='supplementary') submitSupp(blob);
        else submitMain(blob);
        stream.getTracks().forEach(t=>t.stop());
      };
      setAnswerUI('recording');
      mediaRecorder.start();
    }catch(e){ alert('Không thể truy cập micro'); }
  }
  function stopRecording(){
    if(mediaRecorder?.state==='recording') mediaRecorder.stop();
    setAnswerUI('grading');
  }

  async function submitMain(blob){
    if(!socket || socket.readyState!==WebSocket.OPEN){
      alert('Kênh chấm điểm chưa sẵn sàng.'); setAnswerUI('interaction'); return;
    }
    socket.send(JSON.stringify({ type:'asr.stream.start', session_id: elements.sessionId }));
    socket.send(await blob.arrayBuffer());
    socket.send(JSON.stringify({
      type:'asr.stream.end',
      mode:'main',
      process_type:'main',
      session_id: elements.sessionId,
      question_id: examState.currentQuestion.id
    }));
  }
  async function submitSupp(blob){
    if(!socket || socket.readyState!==WebSocket.OPEN){
      alert('Kênh chấm điểm chưa sẵn sàng.'); setAnswerUI('interaction'); return;
    }
    const q = state.suppQueue[state.currentSuppIndex];
    socket.send(JSON.stringify({ type:'asr.stream.start', session_id: elements.sessionId }));
    socket.send(await blob.arrayBuffer());
    socket.send(JSON.stringify({
      type:'asr.stream.end',
      mode:'supplementary',
      process_type:'supplementary',
      session_id: elements.sessionId,
      question_text: q.question_text,
      max_score: 10    // ✅ worker chấm thang 0..10
    }));
  }

  /* ============== Nhận kết quả từ WS ============== */
  function handleExamResult(payload){
    const d = payload.data || {};
    if(payload.type==='main_question_complete'){
      if(!state.mainResults.find(r => r.question_id == d.question_id)){
        const btn = document.querySelector(`[data-question-id="${d.question_id}"]`);
        if(btn){
          btn.classList.add('opacity-60','pointer-events-none');
          const st = btn.querySelector('.q-status');
          if(st){ st.textContent='Đã trả lời'; st.classList.remove('bg-gray-200','text-gray-600'); st.classList.add('bg-green-100','text-green-700'); }
        }
        state.mainResults.push({
          question_id: d.question_id,
          score: d.score,
          transcript: d.transcript,
          feedback: d.feedback,
          analysis: d.analysis || [],
          text: document.querySelector(`[data-question-id="${d.question_id}"] p`)?.textContent || ''
        });
      }
      showScreen('selection');
      setAnswerUI('interaction');
    } else if(payload.type==='supp_question_complete'){
      // ✅ scale về 0..1 và lưu max_score = 1.0
      const rawScore = Number(d.score)||0;
      const rawMax   = Number(d.max_score)||10;
      const scaled   = Math.max(0, Math.min(1, rawScore / rawMax));

      const rec = {
        question_text: d.question_text,
        score: scaled,
        transcript: d.transcript,
        feedback: d.feedback,
        analysis: d.analysis || [],
        max_score: 1.0,
        _saved: false
      };
      state.suppResults.push(rec);
      persistSupplementaryItem(rec).catch(console.error);

      const next = state.currentSuppIndex + 1;
      if(next < state.suppQueue.length) startAnswering(state.suppQueue[next], 'supplementary', next);
      else finalizeAndShowResult();
    }
  }

  /* ============== Kết thúc phần chính ============== */
  function onFinishMainExam(){
    if(state.mainResults.length===0){ alert('Bạn chưa trả lời câu hỏi nào.'); return; }
    state.totalScoreMain = state.mainResults.reduce((s,r)=>s+(Number(r.score)||0),0) / state.mainResults.length;
    state.suppDeadline = Date.now() + SUPP_WINDOW_MS;

    document.getElementById('summaryScore').textContent = fmt(state.totalScoreMain);
    const note   = document.getElementById('summaryNote');
    const btnSupp= document.getElementById('btnStartSupp');
    const btnExit= document.getElementById('btnSummaryExit');

    if(state.totalScoreMain >= 7){
      note.textContent = 'Điểm đạt yêu cầu. Bạn có thể xem kết quả chi tiết và phúc khảo trong 6 phút.';
      btnSupp.style.display='none';
      document.getElementById('suppCountdownWrap').style.display='none';
      btnExit.textContent='Xem kết quả';
      btnExit.onclick = () => { modalHide('summaryModal'); showFinal(false); };
    }else{
      state.eachSuppMax = 1.0; // ✅ cố định 1.0 điểm/câu phụ
      note.innerHTML = `Điểm chưa đạt. Bạn có <b>2 câu hỏi phụ</b>. Mỗi câu tối đa <b>1.00</b> điểm.`;
      btnSupp.style.display='inline-block';
      btnExit.textContent='Đóng';
      btnExit.onclick = () => modalHide('summaryModal');
      btnSupp.onclick = async () => { modalHide('summaryModal'); await startSuppExam(); };
      startSuppCountdown();
    }
    modalShow('summaryModal');
  }

  /* ============== Câu hỏi phụ từ BAREM ============== */
  function pickSupp(){
    const pool = Array.isArray(window.__BAREM__) ? window.__BAREM__ : [];
    const usedIds = new Set(examState.questions.map(q => q.id)); // loại 3 câu chính
    const candidates = pool.filter(b => !usedIds.has(b.id));
    return shuffle(candidates).slice(0,2).map(b => ({ id: b.id, question_text: b.question }));
  }
  async function startSuppExam(){
    state.suppInProgress = true;
    state.suppResults = [];
    document.getElementById('suppSticky').style.display = 'block';

    state.suppQueue = pickSupp();
    if(state.suppQueue.length===0){ alert('Không có câu hỏi phụ phù hợp trong barem.'); finalizeAndShowResult(); return; }
    if(state.suppQueue.length<2){ alert('Barem không đủ 2 câu phụ, hệ thống vẫn tiếp tục.'); }
    startAnswering(state.suppQueue[0], 'supplementary', 0);
  }

  /* ============== Hoàn tất & hiển thị ============== */
  async function saveAllSuppToREST(){
    for(const r of state.suppResults){ if(!r._saved) await persistSupplementaryItem(r); }
  }
  async function finalizeAndShowResult(){
    await saveAllSuppToREST();
    stopSuppCountdown();
    document.getElementById('suppSticky').style.display = 'none';
    const extra = state.suppResults.reduce((s,r)=>s+(Number(r.score)||0),0); // 0..2
    state.totalScoreFinal = state.totalScoreMain + extra;                    // có thể >7, sẽ cap khi hiển thị
    showFinal(true);
  }

  function addDetailButton(htmlIdPrefix, items, isSupp){
    setTimeout(()=>{
      items.forEach((_, idx)=>{
        const btn = document.getElementById(`${htmlIdPrefix}-${idx}`);
        if(!btn) return;
        btn.onclick = () => {
          if(isSupp){
            const r = state.suppResults[idx];
            showAnswerDetail({
              title:`Câu phụ ${idx+1}`,
              question:r.question_text, transcript:r.transcript, feedback:r.feedback,
              analysis:r.analysis, score:r.score, max:1.0
            }, { type:'supp', index:idx });
          }else{
            const r = state.mainResults[idx];
            showAnswerDetail({
              title:`Câu ${idx+1}`,
              question:r.text, transcript:r.transcript, feedback:r.feedback,
              analysis:r.analysis, score:r.score, max:10
            }, { type:'main', index:idx });
          }
        };
      });
    }, 0);
  }

  function showFinal(includeSupp){
    const mainHtml = state.mainResults.map((r,i)=>`
      <div class="card p-4 transition-all hover:shadow-md hover:border-blue-400">
        <p class="text-gray-700 mb-3 line-clamp-2">${r.text || 'Không có nội dung câu hỏi'}</p>
        <div class="flex items-center justify-between border-t border-gray-200 pt-3">
          <div class="text-sm text-gray-500">
            <span class="font-semibold text-gray-800">Câu ${i+1}:</span>
            <b class="ml-2 font-mono text-lg text-blue-600">${fmt(r.score)}</b>
            <span class="font-semibold text-gray-400">/ 10.00</span>
          </div>
          <button id="main-detail-${i}" class="btn btn-sm">Xem chi tiết</button>
        </div>
      </div>`).join('');
    document.getElementById('detailMain').innerHTML = mainHtml;
    addDetailButton('main-detail', state.mainResults, false);

    const wrap = document.getElementById('detailSuppWrap');
    if(includeSupp && state.suppResults.length){
      wrap.style.display = 'block';
      const suppHtml = state.suppResults.map((r,i)=>`
        <div class="card p-4 transition-all hover:shadow-md hover:border-green-400">
          <p class="text-gray-700 mb-3 line-clamp-2">${r.question_text || 'Không có nội dung câu hỏi'}</p>
          <div class="flex items-center justify-between border-t border-gray-200 pt-3">
            <div class="text-sm text-gray-500">
              <span class="font-semibold text-gray-800">Câu phụ ${i+1}:</span>
              <b class="ml-2 font-mono text-lg text-green-600">+${fmt(r.score)}</b>
              <span class="font-semibold text-gray-400">/ 1.00</span>
            </div>
            <button id="supp-detail-${i}" class="btn btn-sm">Xem chi tiết</button>
          </div>
        </div>`).join('');
      document.getElementById('detailSupp').innerHTML = suppHtml;
      addDetailButton('supp-detail', state.suppResults, true);
    }else{
      wrap.style.display='none';
    }

    document.getElementById('finalTotalScore').textContent = fmt(Math.min(7, includeSupp ? state.totalScoreFinal : state.totalScoreMain)); // ✅ cap 7.0
    startAppealCountdown();
    modalShow('finalResultModal');
  }

  function showAnswerDetail({title, question, transcript, feedback, analysis, score, max}, context){
    state.appealContext = Object.assign({ question }, context);
    document.getElementById('detailTitle').textContent = title || 'Chi tiết câu trả lời';
    document.getElementById('detailQuestion').textContent   = question || '';
    document.getElementById('detailTranscript').textContent = transcript || '';
    document.getElementById('detailFeedback').textContent   = feedback || '';

    const anaBlk = document.getElementById('detailAnalysisBlock');
    const anaUl  = document.getElementById('detailAnalysis');
    if(Array.isArray(analysis) && analysis.length){
      anaBlk.style.display='block';
      anaUl.innerHTML = analysis.map(a=>`<li>${a}</li>`).join('');
    }else{
      anaBlk.style.display='none';
      anaUl.innerHTML = '';
    }
    document.getElementById('detailScore').textContent = fmt(score||0);
    document.getElementById('detailMax').textContent   = `/ ${fmt(max||10)}`;
    modalShow('answerDetailModal');
  }

  /* ============== Events ============== */
  document.querySelectorAll('.question-choice-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(btn.classList.contains('pointer-events-none')) return;
      const q = { id:Number(btn.dataset.questionId), question_text: btn.dataset.questionText };
      startAnswering(q, 'main');
    });
  });
  elements.backBtn.addEventListener('click', ()=>showScreen('selection'));
  elements.startBtn.addEventListener('click', startRecording);
  elements.stopBtn.addEventListener('click', stopRecording);
  document.getElementById('finish-exam-btn').addEventListener('click', onFinishMainExam);

  document.getElementById('btnCloseDetail').onclick = () => {
    const el = document.getElementById('appealReason'); if(el) el.value='';
    const ct = document.getElementById('appealCount'); if(ct) ct.textContent='0';
    modalHide('answerDetailModal');
  };

  const appealReasonEl = document.getElementById('appealReason');
  const appealCountEl  = document.getElementById('appealCount');
  if(appealReasonEl){
    appealReasonEl.addEventListener('input', ()=>{
      const len = (appealReasonEl.value || '').trim().length;
      if(appealCountEl) appealCountEl.textContent = String(len);
    });
  }
  const btnSubmitAppeal = document.getElementById('btnSubmitAppeal');
  if(btnSubmitAppeal){
    btnSubmitAppeal.addEventListener('click', ()=>{
      const reason = (appealReasonEl?.value || '').trim();
      if(!reason){ alert('Vui lòng nhập lý do phúc khảo.'); return; }
      console.log('APPEAL SUBMIT', { reason, context: state.appealContext });
      alert('Đã ghi nhận yêu cầu phúc khảo.');
      modalHide('answerDetailModal');
    });
  }

  // Gọi finalize_session khi bấm “Hoàn thành”
  const finishBtn = document.getElementById('btnFinishAll');
  if(finishBtn){
    finishBtn.addEventListener('click', async (e)=>{
      const btn=e.currentTarget; btn.disabled=true; btn.textContent='Đang lưu...';
      try{
        for(const r of state.suppResults){ if(!r._saved) await persistSupplementaryItem(r); }
        const res = await fetch("{% url 'qna:finalize_session' session.id %}", {
          method:'POST', headers:{'X-CSRFToken': csrfToken}
        });
        const data = await res.json();
        if(data.status==='success' || data.status==='ok'){
          window.location.href = "{% url 'qna:dashboard' %}";
        }else{
          alert(data.message || 'Không thể lưu kết quả.');
          btn.disabled=false; btn.textContent='Hoàn thành';
        }
      }catch(err){
        alert('Lỗi kết nối khi lưu kết quả.');
        btn.disabled=false; btn.textContent='Hoàn thành';
      }
    });
  }

  /* ============== Init ============== */
  connectWS();
  startMainTimer();
});
</script>
{% endblock %}
