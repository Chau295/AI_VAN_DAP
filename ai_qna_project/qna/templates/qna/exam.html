{% extends 'base.html' %}
{% load static %}

{% block title %}Bài thi: {{ subject.name }}{% endblock %}

{% block content %}
<div id="exam-container" class="h-full">
    <div id="question-selection-area">
        <div class="bg-white p-8 rounded-xl shadow-md max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Bốc thăm câu hỏi</h2>
                    <p class="text-gray-500">Vui lòng chọn lần lượt các câu hỏi để trả lời.</p>
                </div>
                <div>
                    <h3 class="text-md font-semibold text-gray-700 text-right">Tổng thời gian còn lại</h3>
                    <div id="main-timer" class="mt-1 text-3xl font-mono bg-red-100 text-red-700 text-center py-2 px-4 rounded-lg">
                        15:00
                    </div>
                </div>
            </div>

            <div id="question-list" class="space-y-4">
                {% for question in selected_questions %}
                <button class="question-choice-btn w-full text-left p-6 bg-gray-50 rounded-lg border-2 border-transparent hover:border-blue-500 hover:bg-blue-50 transition-all focus:outline-none"
                        data-question-id="{{ question.id }}"
                        data-question-text="{{ question.question_text }}">
                    <span class="font-semibold text-lg text-gray-800">Câu hỏi {{ forloop.counter }}:</span>
                    <p class="text-gray-600 mt-1">{{ question.question_text }}</p>
                </button>
                {% endfor %}
            </div>

            <div class="mt-8 pt-6 border-t flex justify-end items-center">
                <button id="finish-exam-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-flag-checkered mr-2"></i>Kết thúc bài thi
                </button>
            </div>
        </div>
    </div>

    <div id="exam-content" class="h-full hidden">
        <div class="bg-white shadow-2xl rounded-2xl flex flex-col md:flex-row overflow-hidden h-full">
            <div class="w-full md:w-2/5 bg-gray-50 border-r border-gray-200 p-6 flex flex-col">
                <div class="flex-shrink-0">
                    <h2 class="text-xl font-bold text-gray-800">Bài thi: {{ subject.name }}</h2>
                    <h3 class="text-md font-semibold text-gray-700 mt-4">Câu hỏi đang trả lời</h3>
                    <p id="question-text" class="mt-2 text-gray-600 bg-gray-100 p-4 rounded-lg min-h-[100px]"></p>
                </div>
                 <div class="flex-shrink-0 mt-auto pt-6">
                     <button id="back-to-selection-btn" class="w-full text-center block bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Quay về danh sách câu hỏi
                    </button>
                 </div>
            </div>
            <div class="w-full md:w-3/5 p-8 flex flex-col items-center justify-center text-center bg-white">
                <div id="interaction-area" class="hidden">
                    <i class="fas fa-microphone-alt text-5xl text-gray-300"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mt-4">Sẵn sàng trả lời</h2>
                    <p class="text-gray-500 mt-2">Nhấn nút bên dưới để bắt đầu ghi âm.</p>
                    <button id="start-btn" class="mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-all text-lg shadow-lg">
                        <i class="fas fa-play mr-2"></i> Bắt đầu ghi âm
                    </button>
                </div>
                <div id="recording-area" class="hidden w-full">
                    <h2 class="text-2xl font-bold text-blue-600 mt-4">Đang ghi âm...</h2>
                    <p class="text-gray-500 mt-2">Hãy nói rõ ràng vào microphone. Nhấn Dừng để nộp bài.</p>
                    <button id="stop-btn" class="mt-8 bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition-all text-lg shadow-lg">
                        <i class="fas fa-stop mr-2"></i> Dừng & Nộp bài
                    </button>
                </div>
                <div id="grading-area" class="hidden">
                     <i class="fas fa-spinner fa-spin text-5xl text-gray-400"></i>
                     <h2 class="text-2xl font-bold text-gray-800 mt-4">Đang chấm điểm...</h2>
                     <p class="text-gray-500 mt-2">Hệ thống đang phân tích câu trả lời. Vui lòng chờ.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-finish-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md text-center p-8">
            <h2 class="text-2xl font-bold text-gray-800">Xác nhận kết thúc</h2>
            <p class="text-gray-600 my-4">Bạn có chắc chắn muốn kết thúc và nộp bài thi không? Các câu hỏi chưa trả lời sẽ được tính 0 điểm.</p>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="cancel-finish-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Hủy</button>
                <button id="confirm-finish-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Xác nhận</button>
            </div>
        </div>
    </div>

    <div id="final-result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Kết quả bài thi: {{ subject.name }}</h2>
            </div>
            <div id="modal-body" class="p-6 space-y-4 overflow-y-auto"></div>
            <div class="p-6 border-t bg-gray-50 rounded-b-xl flex justify-between items-center">
                 <div>
                    <span class="text-lg font-semibold text-gray-700">Tổng điểm cuối cùng:</span>
                    <span id="final-total-score" class="text-3xl font-bold text-blue-600"></span>
                    <span class="text-gray-600">/ 10</span>
                 </div>
                 <div id="re-evaluation-timer-container" class="text-center">
                    <span class="text-sm text-gray-600">Thời gian phúc khảo còn lại:</span>
                    <div id="re-evaluation-timer" class="font-mono text-xl text-red-600">10:00</div>
                </div>
                <button id="complete-exam-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                    Hoàn thành
                </button>
            </div>
        </div>
    </div>

    <div id="question-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="detail-modal-title" class="text-2xl font-bold text-gray-800">Chi tiết câu trả lời</h2>
                <button id="close-detail-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="detail-modal-body" class="p-6 space-y-4 overflow-y-auto"></div>
            <div id="detail-modal-footer" class="p-6 border-t bg-gray-50 rounded-b-xl flex justify-end">
                </div>
        </div>
    </div>

    <div id="confirm-complete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md text-center p-8">
            <h2 class="text-2xl font-bold text-gray-800">Xác nhận Hoàn thành</h2>
            <p class="text-gray-600 my-4">Bạn có chắc chắn muốn hoàn thành và thoát khỏi trang kết quả không?</p>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="cancel-complete-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Hủy</button>
                <a href="{% url 'dashboard' %}" id="confirm-complete-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Xác nhận</a>
            </div>
        </div>
    </div>

</div>

{{ subject.subject_code|json_script:"subject_code_data" }}
{{ session.id|json_script:"session_id_data" }}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // === TRẠNG THÁI CỦA BÀI THI ===
    const examState = {
        questions: Array.from(document.querySelectorAll('.question-choice-btn')).map(btn => ({
            id: btn.dataset.questionId,
            text: btn.dataset.questionText,
            answered: false,
            result: null,
            resultId: null
        })),
        currentQuestion: null,
        answeredCount: 0,
    };

    // === CÁC ELEMENT GIAO DIỆN ===
    const questionSelectionArea = document.getElementById('question-selection-area');
    const examContent = document.getElementById('exam-content');
    const questionListContainer = document.getElementById('question-list');
    const finalResultModal = document.getElementById('final-result-modal');
    const modalBody = document.getElementById('modal-body');
    const finalTotalScoreEl = document.getElementById('final-total-score');
    const confirmFinishModal = document.getElementById('confirm-finish-modal');
    const confirmCompleteModal = document.getElementById('confirm-complete-modal');
    const questionDetailModal = document.getElementById('question-detail-modal');
    const detailModalBody = document.getElementById('detail-modal-body');
    const detailModalFooter = document.getElementById('detail-modal-footer');

    const elements = {
        mainTimer: document.getElementById('main-timer'),
        interactionArea: document.getElementById('interaction-area'),
        recordingArea: document.getElementById('recording-area'),
        gradingArea: document.getElementById('grading-area'),
        startBtn: document.getElementById('start-btn'),
        stopBtn: document.getElementById('stop-btn'),
        questionText: document.getElementById('question-text'),
        backToSelectionBtn: document.getElementById('back-to-selection-btn'),
        finishExamBtn: document.getElementById('finish-exam-btn'),
        cancelFinishBtn: document.getElementById('cancel-finish-btn'),
        confirmFinishBtn: document.getElementById('confirm-finish-btn'),
        completeExamBtn: document.getElementById('complete-exam-btn'),
        cancelCompleteBtn: document.getElementById('cancel-complete-btn'),
        closeDetailModalBtn: document.getElementById('close-detail-modal-btn'),
        // === THÊM LẠI ELEMENT CỦA TIMER PHÚC KHẢO ===
        reEvalTimer: document.getElementById('re-evaluation-timer'),
        reEvalTimerContainer: document.getElementById('re-evaluation-timer-container'),
        subjectCode: JSON.parse(document.getElementById('subject_code_data').textContent),
        sessionId: JSON.parse(document.getElementById('session_id_data').textContent),
    };

    let socket;
    let mediaRecorder;
    let mainTimerInterval;
    let reEvalTimerInterval;
    let reEvalTimeLeft = 600;
    let reEvalAllowed = false;

    const TOTAL_EXAM_DURATION = 900;

    // === CÁC HÀM XỬ LÝ ===

    const formatTime = (seconds) => {
        if (seconds < 0) seconds = 0;
        const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${minutes}:${secs}`;
    };

    const updateUIState = (state) => {
        ['interactionArea', 'recordingArea', 'gradingArea'].forEach(area => {
            elements[area].classList.add('hidden');
        });
        if (state) elements[state].classList.remove('hidden');
    };

    const showQuestionDetail = (questionData) => {
        const result = questionData.result || { transcript: '', analysis: [], feedback: '', final_score: 0 };
        let analysisHTML = '';
        (result.analysis || []).forEach(item => {
            analysisHTML += `<li class="flex items-center text-gray-700">${item.matched ? '<i class="fas fa-check-circle text-green-500 w-5 mr-2"></i>' : '<i class="fas fa-times-circle text-red-500 w-5 mr-2"></i>'}<span>${item.text}</span></li>`;
        });

        detailModalBody.innerHTML = `
            <div><h3 class="text-lg font-semibold text-gray-700 mb-2">Câu hỏi</h3><p class="text-gray-800 bg-gray-100 p-4 rounded-lg">${questionData.text}</p></div>
            <div><h3 class="text-lg font-semibold text-gray-700 mb-2">Câu trả lời của bạn</h3><p class="text-gray-600 bg-gray-100 p-4 rounded-lg italic">"${result.transcript || '(Không có nội dung)'}"</p></div>
            <div><h3 class="text-lg font-semibold text-gray-700 mb-2">Phân tích đáp án của AI</h3><ul class="p-4 bg-gray-50 rounded-lg space-y-2 text-sm">${analysisHTML || '<li>Không có phân tích.</li>'}</ul></div>
            <div><h3 class="text-lg font-semibold text-gray-700 mb-2">Nhận xét của AI</h3><p class="text-gray-800 bg-yellow-100 p-4 rounded-lg">${result.feedback || '(Không có nhận xét)'}</p></div>
            <div><h3 class="text-lg font-semibold text-gray-700 mb-2">Điểm số</h3><div class="bg-blue-100 p-4 rounded-lg text-center"><span class="text-5xl font-bold text-blue-700">${(result.final_score || 0).toFixed(2)}</span><span class="text-gray-600 text-xl">/ 10</span></div></div>
        `;

        // === CHỈ HIỂN THỊ NÚT PHÚC KHẢO TẠI ĐÂY ===
        if (reEvalAllowed) {
            detailModalFooter.innerHTML = `<button class="re-eval-btn bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Xin phúc khảo</button>`;
        } else {
            detailModalFooter.innerHTML = `<p class="text-center w-full font-bold text-red-600">Đã hết thời gian phúc khảo</p>`;
        }

        questionDetailModal.classList.remove('hidden');
    };

    // === HÀM TIMER NÀY SẼ CẬP NHẬT GIAO DIỆN Ở MODAL CHÍNH ===
    const startReEvaluationTimer = () => {
        reEvalAllowed = true;
        reEvalTimerInterval = setInterval(() => {
            reEvalTimeLeft--;
            if (reEvalTimeLeft >= 0) {
                elements.reEvalTimer.textContent = formatTime(reEvalTimeLeft);
            }
            if (reEvalTimeLeft < 0) {
                reEvalAllowed = false;
                clearInterval(reEvalTimerInterval);
                elements.reEvalTimerContainer.innerHTML = '<span class="text-sm font-bold text-red-600">Đã hết thời gian phúc khảo</span>';

                // Vô hiệu hóa tất cả các nút phúc khảo (dù nó đang ẩn)
                document.querySelectorAll('.re-eval-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
            }
        }, 1000);
    };

    const showFinalResults = () => {
        clearInterval(mainTimerInterval);
        modalBody.innerHTML = '';
        let totalScore = 0;

        examState.questions.forEach((q, index) => {
            const result = q.result || { final_score: 0, transcript: '(Chưa trả lời)' };
            totalScore += result.final_score || 0;

            const resultHTML = `
                <div class="p-4 border rounded-lg">
                    <p class="font-semibold text-gray-800">Câu ${index + 1}: ${q.text}</p>
                    <div class="mt-3 flex justify-between items-center">
                        <p class="font-bold text-lg">Điểm: <span class="text-blue-600">${result.final_score.toFixed(2)}/10</span></p>
                        <div class="space-x-4">
                            <button class="view-detail-btn text-sm text-blue-600 hover:underline" data-question-id="${q.id}">Xem chi tiết</button>
                        </div>
                    </div>
                </div>
            `;
            modalBody.innerHTML += resultHTML;
        });

        const finalScaledScore = (totalScore / examState.questions.length).toFixed(2);
        finalTotalScoreEl.textContent = finalScaledScore;

        questionSelectionArea.classList.add('hidden');
        examContent.classList.add('hidden');
        finalResultModal.classList.remove('hidden');

        fetch("{% url 'complete_session' %}", {
            method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ session_id: elements.sessionId })
        }).then(res => res.json()).then(data => {
            console.log('Đã đánh dấu hoàn thành bài thi. Bắt đầu tính giờ phúc khảo.');
            startReEvaluationTimer();
        });
    };

    const handleQuestionAnswered = (resultData) => {
        const data = resultData || {};
        const question = examState.questions.find(q => q.id === examState.currentQuestion.id);
        question.answered = true;
        question.result = data;
        examState.answeredCount++;

        const answeredButton = document.querySelector(`[data-question-id="${question.id}"]`);
        answeredButton.disabled = true;
        answeredButton.classList.add('bg-green-100', 'border-green-500', 'cursor-not-allowed', 'opacity-60');
        answeredButton.innerHTML += '<i class="fas fa-check-circle text-green-500 ml-auto absolute right-6 top-1/2 -translate-y-1/2"></i>';
        answeredButton.style.position = 'relative';

        fetch("{% url 'save_result' %}", {
            method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({...data, session_id: elements.sessionId})
        })
        .then(response => response.json())
        .then(apiResponse => {
            if (apiResponse.status === 'success') {
                question.resultId = apiResponse.exam_result_id;
            } else {
                console.error(`Lỗi khi lưu kết quả câu ${question.id}:`, apiResponse.message);
            }
        });

        if (examState.answeredCount === examState.questions.length) {
            showFinalResults();
        } else {
            examContent.classList.add('hidden');
            questionSelectionArea.classList.remove('hidden');
        }
    };

    const startMainTimer = () => {
        let timeLeft = TOTAL_EXAM_DURATION;
        elements.mainTimer.textContent = formatTime(timeLeft);
        mainTimerInterval = setInterval(() => {
            timeLeft--;
            elements.mainTimer.textContent = formatTime(timeLeft);
            if (timeLeft <= 0) {
                clearInterval(mainTimerInterval);
                alert("Đã hết thời gian làm bài! Hệ thống sẽ tự động nộp bài.");
                document.querySelectorAll('.question-choice-btn:not(:disabled)').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                showFinalResults();
            }
        }, 1000);
    };

    const startRecording = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
            const wsPath = `${wsScheme}://${window.location.host}/ws/exam/${elements.subjectCode}/?question_id=${examState.currentQuestion.id}`;
            socket = new WebSocket(wsPath);

            socket.onopen = () => {
                updateUIState('recordingArea');
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) socket.send(event.data);
                };
                mediaRecorder.start(1000);
            };

            socket.onmessage = event => {
                const message = JSON.parse(event.data);
                if (message.type === 'result') {
                    handleQuestionAnswered(message.data || {});
                }
            };
            socket.onclose = () => console.log("WebSocket disconnected.");
            socket.onerror = (error) => console.error("WebSocket Error:", error);
        } catch (err) {
            alert("Không thể truy cập microphone. Vui lòng cấp quyền và thử lại.");
        }
    };

    const stopRecording = () => {
        if (mediaRecorder?.state === 'recording') mediaRecorder.stop();
        if (socket?.readyState === WebSocket.OPEN) socket.send(JSON.stringify({ 'type': 'end_of_stream' }));
        updateUIState('gradingArea');
    };

    // === GÁN SỰ KIỆN BAN ĐẦU ===

    questionListContainer.addEventListener('click', (event) => {
        const button = event.target.closest('.question-choice-btn');
        if (!button || button.disabled) return;

        const questionId = button.dataset.questionId;
        examState.currentQuestion = examState.questions.find(q => q.id === questionId);

        elements.questionText.textContent = examState.currentQuestion.text;
        questionSelectionArea.classList.add('hidden');
        examContent.classList.remove('hidden');
        updateUIState('interactionArea');
    });

    elements.backToSelectionBtn.addEventListener('click', () => {
        examContent.classList.add('hidden');
        questionSelectionArea.classList.remove('hidden');
        examState.currentQuestion = null;
    });

    elements.finishExamBtn.addEventListener('click', () => {
        confirmFinishModal.classList.remove('hidden');
    });

    elements.cancelFinishBtn.addEventListener('click', () => {
        confirmFinishModal.classList.add('hidden');
    });

    elements.confirmFinishBtn.addEventListener('click', () => {
        confirmFinishModal.classList.add('hidden');
        showFinalResults();
    });

    elements.completeExamBtn.addEventListener('click', () => {
        confirmCompleteModal.classList.remove('hidden');
    });
     elements.cancelCompleteBtn.addEventListener('click', () => {
        confirmCompleteModal.classList.add('hidden');
    });

    modalBody.addEventListener('click', (event) => {
        if (event.target.classList.contains('view-detail-btn')) {
            const questionId = event.target.dataset.questionId;
            const questionData = examState.questions.find(q => q.id === questionId);
            if (questionData && questionData.answered) {
                showQuestionDetail(questionData);
            }
        }
    });

    elements.closeDetailModalBtn.addEventListener('click', () => {
        questionDetailModal.classList.add('hidden');
    });

    elements.startBtn.addEventListener('click', startRecording);
    elements.stopBtn.addEventListener('click', stopRecording);

    startMainTimer();
});
</script>
{% endblock %}