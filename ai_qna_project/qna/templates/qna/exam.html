{% extends 'base.html' %}
{% load static %}

{% block title %}Bài thi: {{ subject.name }}{% endblock %}

{% block content %}
<div id="exam-container" class="h-full">
  <div id="question-selection-area">
    <div class="bg-white p-8 rounded-xl shadow-md max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <div>
          <h2 class="text-3xl font-bold text-gray-800">Phần câu hỏi chính</h2>
          <p class="text-gray-500">Vui lòng chọn lần lượt các câu hỏi để trả lời.</p>
        </div>
        <div>
          <h3 class="text-md font-semibold text-gray-700 text-right">Tổng thời gian thi còn lại</h3>
          <div id="main-timer" class="mt-1 text-3xl font-mono bg-red-100 text-red-700 text-center py-2 px-4 rounded-lg">15:00</div>
        </div>
      </div>

      <div id="question-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-auto pr-1">
        {% for question in selected_questions %}
        <button
          class="question-choice-btn w-full h-full text-left p-5 bg-white rounded-xl border border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all focus:outline-none flex flex-col justify-between"
          data-question-id="{{ question.id }}"
          data-question-text="{{ question.question_text }}">
          <div class="flex items-start justify-between gap-2">
            <span class="font-semibold text-base text-gray-800">Câu hỏi {{ forloop.counter }}</span>
            <span class="q-status inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600">Chưa trả lời</span>
          </div>
          <p class="text-gray-600 mt-3 line-clamp-3">{{ question.question_text }}</p>
        </button>
        {% empty %}
        <div class="text-center text-gray-600">Không có câu hỏi chính nào.</div>
        {% endfor %}
      </div>

      <div class="mt-8 pt-6 border-t flex justify-end items-center">
        <button id="finish-exam-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
          <i class="fas fa-flag-checkered mr-2"></i>Kết thúc phần chính
        </button>
      </div>
    </div>
  </div>

  <div id="answer-area" class="h-full hidden">
    <div class="bg-white shadow-2xl rounded-2xl flex flex-col md:flex-row overflow-hidden h-full">
      <div class="w-full md:w-2/5 bg-gray-50 border-r border-gray-200 p-6 flex flex-col">
        <h2 id="answer-area-title" class="text-xl font-bold text-gray-800">Bài thi: {{ subject.name }}</h2>
        <p id="answer-area-question" class="mt-2 text-gray-600 bg-gray-100 p-4 rounded-lg min-h-[100px]"></p>
        <div class="flex-shrink-0 mt-auto py-6">
          <button id="back-to-selection-btn" class="w-full text-center block bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Quay về danh sách
          </button>
        </div>
      </div>

      <div class="w-full md:w-3/5 p-8 flex flex-col items-center justify-center text-center bg-white">
        <div id="interaction-state">
          <i class="fas fa-microphone-alt text-5xl text-gray-300"></i>
          <h2 class="text-2xl font-bold text-gray-800 mt-4">Sẵn sàng trả lời</h2>
          <p class="text-gray-500 mt-2">Nhấn nút bên dưới để bắt đầu ghi âm.</p>
          <button id="start-recording-btn" class="mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-all text-lg shadow-lg">
            <i class="fas fa-play mr-2"></i> Bắt đầu
          </button>
        </div>
        <div id="recording-state" class="hidden w-full">
          <h2 class="text-2xl font-bold text-blue-600 mt-4">Đang ghi âm...</h2>
          <p class="text-gray-500 mt-2">Hãy nói rõ ràng. Nhấn Dừng để nộp bài.</p>
          <button id="stop-recording-btn" class="mt-8 bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition-all text-lg shadow-lg">
            <i class="fas fa-stop mr-2"></i> Dừng & Nộp bài
          </button>
        </div>
        <div id="grading-state" class="hidden">
          <i class="fas fa-spinner fa-spin text-5xl text-gray-400"></i>
          <h2 class="text-2xl font-bold text-gray-800 mt-4">Đang chấm điểm...</h2>
        </div>
      </div>
    </div>
  </div>

  <div id="sticky-timer" style="display:none; position:fixed; right:16px; bottom:16px; z-index:9998;">
    <div style="background:#111827; color:#fff; padding:8px 12px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2)">
      Thời gian còn: <span id="sticky-timer-display" class="font-mono font-bold">15:00</span>
    </div>
  </div>

  <div id="summaryModal" class="modal" style="display:none;">
      <div class="modal-content w-full max-w-lg bg-white rounded-xl shadow-2xl flex flex-col m-4">
          <div class="p-6 border-b border-gray-200">
              <h3 class="text-2xl font-bold text-gray-800">Kết quả phần thi chính</h3>
          </div>
          <div class="p-8 flex-grow text-center">
              <p class="text-gray-600 mb-2">Điểm trung bình của bạn là:</p>
              <div id="summaryScore" class="text-6xl font-extrabold text-gray-900 leading-none">0.00</div>
              <div id="summaryNote" class="mt-4 text-gray-700 bg-gray-50 p-4 rounded-lg"></div>
          </div>
          <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-xl flex items-center justify-end gap-3">
              <button id="btnSummaryExit" class="btn">Đóng</button>
              <button id="btnStartSupp" class="btn btn-primary" style="display:none;">Bắt đầu thi câu hỏi phụ</button>
          </div>
      </div>
  </div>

  <div id="finalResultModal" class="modal" style="display:none;">
      <div class="modal-content w-full max-w-5xl bg-white rounded-xl shadow-2xl flex flex-col h-[90vh] max-h-[800px] m-4">
          <div class="p-6 border-b border-gray-200 flex-shrink-0">
              <h3 class="text-2xl font-bold text-gray-800">Kết quả chi tiết</h3>
          </div>
          <div class="flex-grow overflow-y-auto p-2 sm:p-6">
              <div class="grid gap-8 lg:grid-cols-3">
                  <div class="lg:col-span-2 space-y-4">
                      <div>
                          <h4 class="text-xl font-semibold text-gray-700 mb-4 px-2 sm:px-0">Phần câu hỏi chính</h4>
                          <div id="detailMain" class="space-y-4"></div>
                      </div>

                      <div id="detailSuppWrap" class="mt-8" style="display:none;">
                          <h4 class="text-xl font-semibold text-gray-700 mb-4 px-2 sm:px-0">Phần câu hỏi phụ</h4>
                          <div id="detailSupp" class="space-y-4"></div>
                      </div>
                  </div>
                  <div class="lg:col-span-1">
                      <div class="sticky top-0 p-1">
                          <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                              <div class="text-sm font-medium text-gray-600 mb-1">Tổng điểm cuối cùng</div>
                              <div class="text-5xl font-extrabold text-blue-600 leading-none">
                                  <span id="finalTotalScore">0.00</span><span class="text-gray-400 text-2xl">/10</span>
                              </div>
                              <div id="finalScoreNote" class="text-xs text-gray-500 mt-1"></div>
                              <div class="mt-6 border-t pt-4">
                                  <div id="appealTimer">
                                      <div class="text-sm font-medium text-gray-600">Thời gian phúc khảo còn lại:</div>
                                      <div id="appealCountdown" class="font-mono text-2xl font-bold text-indigo-600 mt-1">06:00</div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-xl flex-shrink-0 flex items-center justify-end">
              <button id="btnFinishAll" class="btn btn-primary">Hoàn thành và về trang chủ</button>
          </div>
      </div>
  </div>

  <div id="answerDetailModal" class="modal" style="display:none;">
      <div class="modal-content w-full max-w-4xl bg-white rounded-xl shadow-2xl flex flex-col h-[90vh] max-h-[800px] m-4">
          <div class="p-6 border-b border-gray-200 flex-shrink-0">
              <h3 id="detailTitle" class="text-2xl font-bold text-gray-800">Chi tiết câu trả lời</h3>
          </div>
          <div class="p-6 flex-grow overflow-y-auto space-y-4">
              <div class="card p-4"><div class="text-sm text-gray-500">Câu hỏi</div><div id="detailQuestion" class="mt-1 font-semibold text-gray-800"></div></div>
              <div class="card p-4"><div class="text-sm text-gray-500">Câu trả lời của bạn</div><div id="detailTranscript" class="mt-1 text-gray-800 italic"></div></div>
              <div class="card p-4"><div class="text-sm text-gray-500">Nhận xét</div><div id="detailFeedback" class="mt-1 text-gray-800"></div></div>
              <div id="detailAnalysisBlock" class="card p-4" style="display:none;"><div class="text-sm text-gray-500">Phân tích đáp án</div><ul id="detailAnalysis" class="mt-2 list-disc list-inside text-gray-800"></ul></div>
              <div class="card p-4 flex items-center justify-between"><div class="text-sm text-gray-500">Điểm</div><div><span id="detailScore" class="text-2xl font-bold text-blue-600">0.00</span><span id="detailMax" class="text-gray-500"></span></div></div>
              <div id="appealFormBlock" class="bg-yellow-50 p-5 rounded-lg border border-yellow-200 mt-2">
                  <h4 class="text-lg font-semibold text-yellow-800 mb-2">Xin phúc khảo</h4>
                  <label for="appealReason" class="text-sm text-gray-700">Lý do phúc khảo (tối đa 300 ký tự)</label>
                  <textarea id="appealReason" class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-yellow-400" rows="3" maxlength="300" placeholder="Trình bày rõ ràng lý do bạn cho rằng câu trả lời xứng đáng điểm cao hơn..."></textarea>
                  <div class="mt-1 text-xs text-gray-500 text-right"><span id="appealCount">0</span>/300</div>
              </div>
          </div>
          <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-xl flex-shrink-0 flex items-center justify-end gap-3">
              <button id="btnCloseDetail" class="btn">Đóng</button>
              <button id="btnSubmitAppeal" class="btn btn-primary">Gửi phúc khảo</button>
          </div>
      </div>
  </div>
</div>

{{ session.id|json_script:"session_id_data" }}
{% csrf_token %}

<style>
  .modal{position:fixed;inset:0;background:rgba(17,24,39,.6);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}.modal-content{}.btn{padding:10px 20px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-weight:600;transition:all .2s;box-shadow:0 1px 2px 0 rgba(0,0,0,.05)}.btn:hover{border-color:#9ca3af;background:#f9fafb}.btn-primary{border-color:#2563eb;background:#2563eb;color:#fff}.btn-primary:hover{background:#1d4ed8;border-color:#1d4ed8}.btn-sm{padding:6px 12px;font-size:.875rem;border-radius:6px}.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.05)}.line-clamp-2{overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2}.line-clamp-3{overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3}#finalResultModal .overflow-y-auto::-webkit-scrollbar,#answerDetailModal .overflow-y-auto::-webkit-scrollbar{width:8px}#finalResultModal .overflow-y-auto::-webkit-scrollbar-track,#answerDetailModal .overflow-y-auto::-webkit-scrollbar-track{background:0 0}#finalResultModal .overflow-y-auto::-webkit-scrollbar-thumb,#answerDetailModal .overflow-y-auto::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:4px}#finalResultModal .overflow-y-auto::-webkit-scrollbar-thumb:hover,#answerDetailModal .overflow-y-auto::-webkit-scrollbar-thumb:hover{background:#9ca3af}
</style>
{% endblock %}

{% block extra_js %}
<script>
  window.__BAREM__ = {{ barem_json|default:"[]"|safe }};
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ==========================================================================
     CONFIG & STATE
     ========================================================================== */
  const EXAM_TOTAL_DURATION_MS = 15 * 60 * 1000;
  const APPEAL_WINDOW_MS = 6  * 60 * 1000;
  const SUPP_MAX_COUNT = 2; // Số câu hỏi phụ tối đa
  const FINAL_CAP = 7.0; // Điểm tối đa khi có câu hỏi phụ
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const SESSION_ID = JSON.parse(document.getElementById('session_id_data').textContent);

  const API_ENDPOINTS = {
    SAVE_SUPP: "/api/save-supplementary-result/",
    FINALIZE: "{% url 'qna:finalize_session' session.id %}"
  };

  const elements = {
    selection: document.getElementById('question-selection-area'),
    answer: document.getElementById('answer-area'),
    backBtn: document.getElementById('back-to-selection-btn'),
    startBtn: document.getElementById('start-recording-btn'),
    stopBtn: document.getElementById('stop-recording-btn'),
    interaction: document.getElementById('interaction-state'),
    recording: document.getElementById('recording-state'),
    grading: document.getElementById('grading-state'),
    aTitle: document.getElementById('answer-area-title'),
    aQuestion: document.getElementById('answer-area-question'),
    stickyTimer: document.getElementById('sticky-timer'),
    stickyTimerDisplay: document.getElementById('sticky-timer-display'),
  };

  const state = {
    questions: [], // Lưu trữ thông tin các câu hỏi chính
    mainResults: [],
    suppResults: [],
    currentQuestion: null,
    totalScoreMain: 0,
    suppInProgress: false,
    suppQueue: [],
    currentSuppIndex: -1,
    examFinished: false,
    mainTimerEnd: null,
    appealDeadline: null,
    appealContext: null,
    socket: null,
    mediaRecorder: null,
    audioChunks: []
  };

  // Khởi tạo danh sách câu hỏi chính từ DOM
  document.querySelectorAll('.question-choice-btn').forEach(btn => {
    state.questions.push({
      id: Number(btn.dataset.questionId),
      question_text: btn.dataset.questionText,
      answered: false
    });
  });

  /* ==========================================================================
     UTILITY FUNCTIONS
     ========================================================================== */
  const modal = {
    show: (id) => { document.getElementById(id).style.display = 'flex'; },
    hide: (id) => { document.getElementById(id).style.display = 'none'; }
  };
  const formatScore = (n) => (Math.round(Number(n || 0) * 100) / 100).toFixed(2);
  const formatTime = (ms) => {
    const s = Math.max(0, Math.ceil(ms / 1000));
    const m = Math.floor(s / 60);
    const rs = s % 60;
    return `${String(m).padStart(2, '0')}:${String(rs).padStart(2, '0')}`;
  };
  const shuffleArray = (a) => {
    const arr = [...a];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  };

  async function postJSON(url, data) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      const errorText = await res.text();
      console.error(`API Error on ${url}:`, errorText);
      throw new Error(errorText);
    }
    return res.json();
  }

  /* ==========================================================================
     TIMERS
     ========================================================================== */
  let mainTimerInterval = null;
  let appealTimerInterval = null;

  function startMainTimer(durationMs = EXAM_TOTAL_DURATION_MS) {
    state.mainTimerEnd = Date.now() + durationMs;
    clearInterval(mainTimerInterval);

    const tick = () => {
      const timeLeft = Math.max(0, state.mainTimerEnd - Date.now());
      const timeStr = formatTime(timeLeft);
      document.getElementById('main-timer').textContent = timeStr;
      elements.stickyTimerDisplay.textContent = timeStr;

      if (timeLeft <= 0 && !state.examFinished) {
        state.examFinished = true;
        clearInterval(mainTimerInterval);
        alert('Đã hết thời gian làm bài!');
        if (state.suppInProgress) {
          finalizeAndShowResult();
        } else {
          onFinishMainExam();
        }
      }
    };
    mainTimerInterval = setInterval(tick, 250);
    tick();
  }

  function startAppealCountdown() {
    clearInterval(appealTimerInterval);
    state.appealDeadline = Date.now() + APPEAL_WINDOW_MS;
    appealTimerInterval = setInterval(() => {
      const timeLeft = state.appealDeadline - Date.now();
      document.getElementById('appealCountdown').textContent = formatTime(timeLeft);
      if (timeLeft <= 0) clearInterval(appealTimerInterval);
    }, 250);
  }

  /* ==========================================================================
     UI & SCREEN MANAGEMENT
     ========================================================================== */
  function showScreen(screenName) {
    elements.selection.style.display = (screenName === 'selection') ? 'block' : 'none';
    elements.answer.style.display = (screenName === 'answer') ? 'block' : 'none';
    elements.stickyTimer.style.display = (screenName === 'answer') ? 'block' : 'none';
  }

  function setAnswerUIState(uiState) {
    ['interaction', 'recording', 'grading'].forEach(k => elements[k].style.display = 'none');
    elements[uiState].style.display = 'block';
  }

  function startAnswering(questionData, type, index = -1) {
    state.currentQuestion = { ...questionData, type };
    if (type === 'supplementary') {
      state.currentSuppIndex = index;
      elements.aTitle.textContent = `Câu hỏi phụ ${index + 1}`;
      elements.backBtn.style.display = 'none';
    } else {
      elements.aTitle.textContent = 'Câu hỏi chính';
      elements.backBtn.style.display = 'block';
    }
    elements.aQuestion.textContent = questionData.question_text;
    setAnswerUIState('interaction');
    showScreen('answer');
  }

  /* ==========================================================================
     AUDIO & WEBSOCKET
     ========================================================================== */
  function connectWebSocket() {
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    state.socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/exam/${SESSION_ID}/`);
    state.socket.binaryType = "arraybuffer";
    state.socket.onopen = () => console.log('WebSocket connected.');
    state.socket.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data);
        if (message.type === 'exam.result') handleExamResult(message.message);
        else if (message.type === 'exam.error') {
          alert(message.message || 'Có lỗi xảy ra trong quá trình chấm điểm.');
          setAnswerUIState('interaction');
        }
      } catch (e) { console.error('Error parsing WebSocket message:', e); }
    };
    state.socket.onclose = () => console.warn('WebSocket closed.');
    state.socket.onerror = (err) => console.error('WebSocket error:', err);
  }

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
      state.audioChunks = [];
      state.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
      state.mediaRecorder.ondataavailable = e => { if (e.data.size > 0) state.audioChunks.push(e.data); };
      state.mediaRecorder.onstop = () => {
        const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm;codecs=opus' });
        submitAudio(audioBlob);
        stream.getTracks().forEach(track => track.stop());
      };
      setAnswerUIState('recording');
      state.mediaRecorder.start();
    } catch (e) {
      alert('Không thể truy cập microphone. Vui lòng cấp quyền và thử lại.');
      console.error('Microphone access error:', e);
    }
  }

  function stopRecording() {
    if (state.mediaRecorder?.state === 'recording') {
      state.mediaRecorder.stop();
      setAnswerUIState('grading');
    }
  }

  async function submitAudio(blob) {
    if (!state.socket || state.socket.readyState !== WebSocket.OPEN) {
      alert('Kênh chấm điểm chưa sẵn sàng. Vui lòng thử lại.');
      setAnswerUIState('interaction');
      return;
    }
    const { type, id, question_text } = state.currentQuestion;
    const isSupp = type === 'supplementary';

    state.socket.send(JSON.stringify({ type: 'asr.stream.start', session_id: SESSION_ID }));
    state.socket.send(await blob.arrayBuffer());

    const endMessage = {
      type: 'asr.stream.end',
      mode: isSupp ? 'supplementary' : 'main',
      process_type: isSupp ? 'supplementary' : 'main',
      session_id: SESSION_ID,
      ...(isSupp ? { question_text, max_score: 10 } : { question_id: id })
    };
    state.socket.send(JSON.stringify(endMessage));
  }

  /* ==========================================================================
     RESULT HANDLING & EXAM FLOW
     ========================================================================== */
  function handleExamResult(payload) {
    const data = payload.data || {};
    if (payload.type === 'main_question_complete') {
      const existingResult = state.mainResults.find(r => r.question_id === data.question_id);
      if (!existingResult) {
        state.mainResults.push({
          question_id: data.question_id,
          score: data.score,
          transcript: data.transcript,
          feedback: data.feedback,
          analysis: data.analysis || [],
          text: state.questions.find(q => q.id === data.question_id)?.question_text || ''
        });

        const btn = document.querySelector(`.question-choice-btn[data-question-id="${data.question_id}"]`);
        if (btn) {
          btn.classList.add('opacity-60', 'pointer-events-none');
          const statusEl = btn.querySelector('.q-status');
          if(statusEl) {
            statusEl.textContent = 'Đã trả lời';
            statusEl.className = 'q-status inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700';
          }
        }
      }
      showScreen('selection');
    } else if (payload.type === 'supp_question_complete') {
      const scaledScore = Math.max(0, Math.min(1, (Number(data.score) || 0) / (Number(data.max_score) || 10)));
      const result = {
        question_text: data.question_text, score: scaledScore, transcript: data.transcript,
        feedback: data.feedback, analysis: data.analysis || [], max_score: 1.0, _saved: false
      };
      state.suppResults.push(result);
      persistSupplementaryItem(result);

      const nextIndex = state.currentSuppIndex + 1;
      if (nextIndex < state.suppQueue.length) {
        startAnswering(state.suppQueue[nextIndex], 'supplementary', nextIndex);
      } else {
        finalizeAndShowResult();
      }
    }
  }

  function onFinishMainExam() {
    // Nếu hết giờ mà chưa trả lời câu nào, kết thúc luôn
    if (state.examFinished && state.mainResults.length === 0) {
        finalizeAndShowResult(true); // Gọi với isTimeout = true
        return;
    }
    if (state.mainResults.length === 0 && !state.examFinished) {
      alert('Bạn chưa trả lời câu hỏi nào.');
      return;
    }

    // *** LOGIC TÍNH ĐIỂM ĐÃ CẬP NHẬT ***
    // Luôn chia cho tổng số câu hỏi chính (state.questions.length) để tính đúng điểm trung bình.
    // Câu chưa trả lời sẽ có điểm là 0.
    const sumOfScores = state.mainResults.reduce((sum, result) => sum + (Number(result.score) || 0), 0);
    state.totalScoreMain = sumOfScores / state.questions.length;

    document.getElementById('summaryScore').textContent = formatScore(state.totalScoreMain);
    const noteEl = document.getElementById('summaryNote');
    const btnSupp = document.getElementById('btnStartSupp');
    const btnExit = document.getElementById('btnSummaryExit');

    if (state.totalScoreMain >= 7) {
      noteEl.textContent = 'Điểm của bạn đã đạt yêu cầu. Bạn có thể xem kết quả chi tiết.';
      btnSupp.style.display = 'none';
      btnExit.textContent = 'Xem kết quả';
      btnExit.onclick = () => { modal.hide('summaryModal'); showFinalResult(false); };
    } else {
      noteEl.innerHTML = `Điểm chưa đạt yêu cầu. Bạn có thể làm <b>${SUPP_MAX_COUNT} câu hỏi phụ</b> trong thời gian thi còn lại.`;
      btnSupp.style.display = 'inline-block';
      btnExit.textContent = 'Để sau';
      btnExit.onclick = () => modal.hide('summaryModal');
      btnSupp.onclick = async () => { modal.hide('summaryModal'); await startSuppExam(); };
    }
    modal.show('summaryModal');
  }

  async function startSuppExam() {
    state.suppInProgress = true;
    state.suppResults = [];
    state.suppQueue = shuffleArray(window.__BAREM__ || []).slice(0, SUPP_MAX_COUNT).map(b => ({ id: b.id, question_text: b.question }));

    if (state.suppQueue.length === 0) {
      alert('Không có câu hỏi phụ nào trong hệ thống.');
      finalizeAndShowResult();
      return;
    }
    startAnswering(state.suppQueue[0], 'supplementary', 0);
  }

  async function persistSupplementaryItem(result) {
    if (result._saved) return;
    try {
      const data = await postJSON(API_ENDPOINTS.SAVE_SUPP, {
        session_id: SESSION_ID,
        question_text: result.question_text,
        transcript: result.transcript,
        score: result.score, // Score đã được chuẩn hóa về thang 1
        max_score: 1.0,
        feedback: result.feedback,
        analysis: result.analysis
      });
      result._saved = true;
      result._id = data?.supplementary_result_id;
    } catch (e) { console.error('Failed to persist supplementary item:', e); }
  }

  async function finalizeAndShowResult(isTimeout = false) {
    // Đảm bảo tất cả kết quả phụ đã được lưu
    await Promise.all(state.suppResults.map(r => persistSupplementaryItem(r)));
    showFinalResult(state.suppInProgress || isTimeout);
  }

  function showFinalResult(includeSupp) {
    const renderDetailCard = (item, index, isSupp) => `
      <div class="card p-4 transition-all hover:shadow-md ${isSupp ? 'hover:border-green-400' : 'hover:border-blue-400'}">
        <p class="text-gray-700 mb-3 line-clamp-2">${item.text || item.question_text || 'Không có nội dung câu hỏi'}</p>
        <div class="flex items-center justify-between border-t border-gray-200 pt-3">
          <div class="text-sm text-gray-500">
            <span class="font-semibold text-gray-800">${isSupp ? `Câu phụ ${index + 1}` : `Câu ${index + 1}`}:</span>
            <b class="ml-2 font-mono text-lg ${isSupp ? 'text-green-600' : 'text-blue-600'}">
              ${isSupp ? '+' : ''}${formatScore(item.score)}
            </b>
            <span class="font-semibold text-gray-400">/ ${isSupp ? '1.00' : '10.00'}</span>
          </div>
          <button data-type="${isSupp ? 'supp' : 'main'}" data-index="${index}" class="btn btn-sm detail-btn">Xem chi tiết</button>
        </div>
      </div>`;

    document.getElementById('detailMain').innerHTML = state.mainResults.map((r, i) => renderDetailCard(r, i, false)).join('');

    const suppWrap = document.getElementById('detailSuppWrap');
    if (includeSupp && state.suppResults.length) {
      suppWrap.style.display = 'block';
      document.getElementById('detailSupp').innerHTML = state.suppResults.map((r, i) => renderDetailCard(r, i, true)).join('');
    } else {
      suppWrap.style.display = 'none';
    }

    const suppScoreSum = state.suppResults.reduce((sum, r) => sum + (Number(r.score) || 0), 0);
    const finalScore = includeSupp ? Math.min(FINAL_CAP, state.totalScoreMain + suppScoreSum) : state.totalScoreMain;

    document.getElementById('finalTotalScore').textContent = formatScore(finalScore);
    document.getElementById('finalScoreNote').textContent = includeSupp ? `(Điểm tối đa được tính là ${FINAL_CAP} khi có câu hỏi phụ)` : '';

    startAppealCountdown();
    modal.show('finalResultModal');
  }

  function showAnswerDetail({ title, question, transcript, feedback, analysis, score, max }, context) {
    state.appealContext = { question, ...context };
    document.getElementById('detailTitle').textContent = title || 'Chi tiết câu trả lời';
    document.getElementById('detailQuestion').textContent = question || '';
    document.getElementById('detailTranscript').textContent = transcript || 'Chưa có bản ghi';
    document.getElementById('detailFeedback').textContent = feedback || 'Chưa có nhận xét';

    const analysisBlock = document.getElementById('detailAnalysisBlock');
    const analysisList = document.getElementById('detailAnalysis');
    if (Array.isArray(analysis) && analysis.length > 0) {
      analysisBlock.style.display = 'block';
      analysisList.innerHTML = analysis.map(a => `<li>${a}</li>`).join('');
    } else {
      analysisBlock.style.display = 'none';
    }
    document.getElementById('detailScore').textContent = formatScore(score);
    document.getElementById('detailMax').textContent = ` / ${formatScore(max)}`;

    document.getElementById('appealReason').value = '';
    document.getElementById('appealCount').textContent = '0';
    modal.show('answerDetailModal');
  }

  /* ==========================================================================
     EVENT LISTENERS
     ========================================================================== */
  function setupEventListeners() {
    document.getElementById('question-list').addEventListener('click', (e) => {
      const btn = e.target.closest('.question-choice-btn');
      if (btn && !btn.classList.contains('pointer-events-none')) {
        const question = state.questions.find(q => q.id === Number(btn.dataset.questionId));
        if (question) startAnswering(question, 'main');
      }
    });

    document.getElementById('finalResultModal').addEventListener('click', (e) => {
        const btn = e.target.closest('.detail-btn');
        if (btn) {
            const type = btn.dataset.type;
            const index = Number(btn.dataset.index);
            const isSupp = type === 'supp';
            const result = isSupp ? state.suppResults[index] : state.mainResults[index];
            showAnswerDetail({
                title: `${isSupp ? 'Câu phụ' : 'Câu'} ${index + 1}`,
                question: result.text || result.question_text,
                transcript: result.transcript, feedback: result.feedback, analysis: result.analysis,
                score: result.score, max: isSupp ? 1.0 : 10.0
            }, { type, index });
        }
    });

    elements.backBtn.onclick = () => showScreen('selection');
    elements.startBtn.onclick = startRecording;
    elements.stopBtn.onclick = stopRecording;
    document.getElementById('finish-exam-btn').onclick = onFinishMainExam;

    document.getElementById('btnCloseDetail').onclick = () => modal.hide('answerDetailModal');
    document.getElementById('btnFinishAll').onclick = async (e) => {
      const btn = e.currentTarget; btn.disabled = true; btn.textContent = 'Đang lưu...';
      try {
        await Promise.all(state.suppResults.map(r => persistSupplementaryItem(r)));
        const data = await postJSON(API_ENDPOINTS.FINALIZE, {});
        if (data.status === 'success') {
          window.location.href = "{% url 'qna:dashboard' %}";
        } else {
          alert(data.message || 'Không thể lưu kết quả cuối cùng.');
          btn.disabled = false; btn.textContent = 'Hoàn thành';
        }
      } catch (err) {
        alert('Lỗi kết nối khi lưu kết quả.');
        btn.disabled = false; btn.textContent = 'Hoàn thành';
      }
    };

    const appealReasonEl = document.getElementById('appealReason');
    appealReasonEl.oninput = () => {
      document.getElementById('appealCount').textContent = String(appealReasonEl.value.trim().length);
    };
    document.getElementById('btnSubmitAppeal').onclick = () => {
      const reason = appealReasonEl.value.trim();
      if (!reason) {
        alert('Vui lòng nhập lý do phúc khảo.'); return;
      }
      console.log('YÊU CẦU PHÚC KHẢO:', { reason, context: state.appealContext });
      alert('Đã ghi nhận yêu cầu phúc khảo của bạn.');
      modal.hide('answerDetailModal');
    };
  }

  /* ==========================================================================
     INITIALIZATION
     ========================================================================== */
  function init() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) sidebar.classList.add('collapsed');

    setupEventListeners();
    connectWebSocket();
    startMainTimer();
  }

  init();
});
</script>
{% endblock %}