{% extends 'base.html' %}
{% load static %}

{% block title %}Bài thi: {{ subject.name }}{% endblock %}

{% block content %}
<div id="exam-container" class="h-full">
    <!-- VÙNG CHỌN CÂU HỎI -->
    <div id="question-selection-area">
        <div class="bg-white p-8 rounded-xl shadow-md max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Bốc thăm câu hỏi</h2>
                    <p class="text-gray-500">Vui lòng chọn lần lượt các câu hỏi để trả lời.</p>
                </div>
                <div>
                    <h3 class="text-md font-semibold text-gray-700 text-right">Tổng thời gian còn lại</h3>
                    <div id="main-timer" class="mt-1 text-3xl font-mono bg-red-100 text-red-700 text-center py-2 px-4 rounded-lg">
                        15:00
                    </div>
                </div>
            </div>

            <div id="question-list" class="space-y-4">
                {% for question in selected_questions %}
                <button class="question-choice-btn w-full text-left p-6 bg-gray-50 rounded-lg border-2 border-transparent hover:border-blue-500 hover:bg-blue-50 transition-all focus:outline-none relative"
                        data-question-id="{{ question.id }}"
                        data-question-text="{{ question.question_text }}">
                    <span class="font-semibold text-lg text-gray-800">Câu hỏi {{ forloop.counter }}:</span>
                    <p class="text-gray-600 mt-1">{{ question.question_text }}</p>
                </button>
                {% endfor %}
            </div>

            <div class="mt-8 pt-6 border-t flex justify-end items-center">
                <button id="finish-exam-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-flag-checkered mr-2"></i>Kết thúc bài thi
                </button>
            </div>
        </div>
    </div>

    <!-- VÙNG LÀM BÀI THI -->
    <div id="exam-content" class="h-full hidden">
        <div class="bg-white shadow-2xl rounded-2xl flex flex-col md:flex-row overflow-hidden h-full">
            <div class="w-full md:w-2/5 bg-gray-50 border-r border-gray-200 p-6 flex flex-col">
                <div class="flex-shrink-0">
                    <h2 class="text-xl font-bold text-gray-800">Bài thi: {{ subject.name }}</h2>
                    <h3 class="text-md font-semibold text-gray-700 mt-4">Câu hỏi đang trả lời</h3>
                    <p id="question-text" class="mt-2 text-gray-600 bg-gray-100 p-4 rounded-lg min-h-[100px]"></p>
                </div>
                 <div class="flex-shrink-0 mt-auto pt-6">
                     <button id="back-to-selection-btn" class="w-full text-center block bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Quay về danh sách câu hỏi
                    </button>
                 </div>
            </div>
            <div class="w-full md:w-3/5 p-8 flex flex-col items-center justify-center text-center bg-white">
                <!-- Trạng thái: Sẵn sàng -->
                <div id="interaction-area" class="hidden">
                    <i class="fas fa-microphone-alt text-5xl text-gray-300"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mt-4">Sẵn sàng trả lời</h2>
                    <p class="text-gray-500 mt-2">Nhấn nút bên dưới để bắt đầu ghi âm.</p>
                    <button id="start-btn" class="mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-all text-lg shadow-lg">
                        <i class="fas fa-play mr-2"></i> Bắt đầu ghi âm
                    </button>
                </div>
                <!-- Trạng thái: Đang ghi âm -->
                <div id="recording-area" class="hidden w-full">
                    <h2 class="text-2xl font-bold text-blue-600 mt-4">Đang ghi âm...</h2>
                    <p class="text-gray-500 mt-2">Hãy nói rõ ràng vào microphone. Nhấn Dừng để nộp bài.</p>
                    <button id="stop-btn" class="mt-8 bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition-all text-lg shadow-lg">
                        <i class="fas fa-stop mr-2"></i> Dừng & Nộp bài
                    </button>
                </div>
                <!-- Trạng thái: Đang chấm điểm -->
                <div id="grading-area" class="hidden">
                     <i class="fas fa-spinner fa-spin text-5xl text-gray-400"></i>
                     <h2 class="text-2xl font-bold text-gray-800 mt-4">Đang chấm điểm...</h2>
                     <p class="text-gray-500 mt-2">Hệ thống đang phân tích câu trả lời. Vui lòng chờ.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL XÁC NHẬN KẾT THÚC -->
    <div id="confirm-finish-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md text-center p-8">
            <h2 class="text-2xl font-bold text-gray-800">Xác nhận kết thúc</h2>
            <p class="text-gray-600 my-4">Bạn có chắc chắn muốn kết thúc và nộp bài thi không? Các câu hỏi chưa trả lời sẽ được tính 0 điểm.</p>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="cancel-finish-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Hủy</button>
                <button id="confirm-finish-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Xác nhận</button>
            </div>
        </div>
    </div>

    <!-- MODAL KẾT QUẢ CUỐI CÙNG -->
    <div id="final-result-modal"
         data-detail-url-template="{% url 'exam_result_detail' 0 %}"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Kết quả bài thi: {{ subject.name }}</h2>
            </div>
            <div id="modal-body" class="p-6 space-y-6 overflow-y-auto"></div>
            <div class="p-6 border-t bg-gray-50 rounded-b-xl flex justify-between items-center">
                 <div>
                    <span class="text-lg font-semibold text-gray-700">Tổng điểm cuối cùng:</span>
                    <span id="final-total-score" class="text-3xl font-bold text-blue-600"></span>
                    <span class="text-gray-600">/ 10</span>
                 </div>
                <a id="complete-exam-btn" href="{% url 'dashboard' %}" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                    Hoàn thành
                </a>
            </div>
        </div>
    </div>
</div>

{{ subject.subject_code|json_script:"subject_code_data" }}
{{ session.id|json_script:"session_id_data" }}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // === TRẠNG THÁI CỦA BÀI THI ===
    // CẢI TIẾN: Khôi phục trạng thái từ sessionStorage nếu có.
    // Điều này cho phép người dùng quay lại trang mà không mất tiến trình.
    const savedState = sessionStorage.getItem('examState');
    const examState = savedState ? JSON.parse(savedState) : {
        questions: Array.from(document.querySelectorAll('.question-choice-btn')).map(btn => ({
            id: btn.dataset.questionId,
            text: btn.dataset.questionText,
            answered: false,
            result: null,
            resultId: null
        })),
        currentQuestion: null,
        answeredCount: 0,
    };

    // === CÁC ELEMENT GIAO DIỆN ===
    const questionSelectionArea = document.getElementById('question-selection-area');
    const examContent = document.getElementById('exam-content');
    const questionListContainer = document.getElementById('question-list');
    const finalResultModal = document.getElementById('final-result-modal');
    const modalBody = document.getElementById('modal-body');
    const finalTotalScoreEl = document.getElementById('final-total-score');
    const confirmFinishModal = document.getElementById('confirm-finish-modal');

    const elements = {
        mainTimer: document.getElementById('main-timer'),
        interactionArea: document.getElementById('interaction-area'),
        recordingArea: document.getElementById('recording-area'),
        gradingArea: document.getElementById('grading-area'),
        startBtn: document.getElementById('start-btn'),
        stopBtn: document.getElementById('stop-btn'),
        questionText: document.getElementById('question-text'),
        backToSelectionBtn: document.getElementById('back-to-selection-btn'),
        finishExamBtn: document.getElementById('finish-exam-btn'),
        cancelFinishBtn: document.getElementById('cancel-finish-btn'),
        confirmFinishBtn: document.getElementById('confirm-finish-btn'),
        completeExamBtn: document.getElementById('complete-exam-btn'),
        subjectCode: JSON.parse(document.getElementById('subject_code_data').textContent),
        sessionId: JSON.parse(document.getElementById('session_id_data').textContent),
        detailUrlTemplate: finalResultModal.dataset.detailUrlTemplate,
    };

    let socket;
    let mediaRecorder;
    let mainTimerInterval;
    const TOTAL_EXAM_DURATION = 900; // 15 phút

    // === CÁC HÀM XỬ LÝ ===

    const formatTime = (seconds) => {
        const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${minutes}:${secs}`;
    };

    const updateUIState = (state) => {
        ['interactionArea', 'recordingArea', 'gradingArea'].forEach(area => {
            elements[area].classList.add('hidden');
        });
        if (state) elements[state].classList.remove('hidden');
    };

    const showFinalResults = () => {
        // CẢI TIẾN: Lưu trạng thái hiện tại và cờ hiển thị modal vào sessionStorage.
        sessionStorage.setItem('examState', JSON.stringify(examState));
        sessionStorage.setItem('showResultsModal', 'true');

        clearInterval(mainTimerInterval);
        modalBody.innerHTML = '';
        let totalScore = 0;

        examState.questions.forEach((q, index) => {
            const result = q.result || { final_score: 0, transcript: '(Chưa trả lời)' };
            totalScore += result.final_score || 0;

            // CẢI TIẾN: Bỏ target="_blank" để cho phép điều hướng trong cùng một tab,
            // giúp nút "Back" của trình duyệt hoạt động đúng như mong đợi.
            const detailUrl = q.answered && q.resultId ? elements.detailUrlTemplate.replace('0', q.resultId) : '#';

            const resultHTML = `
                <div class="p-4 border rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-gray-800">Câu ${index + 1}: ${q.text}</p>
                            <p class="text-sm text-gray-500 mt-2">Điểm: <span class="font-bold text-lg text-blue-600">${result.final_score || 0}/10</span></p>
                        </div>
                        <div class="text-right space-x-4 flex-shrink-0 ml-4">
                            <a href="${detailUrl}" class="text-sm text-blue-600 hover:underline">Xem chi tiết</a>
                            <button class="text-sm text-indigo-600 hover:underline">Xin phúc khảo</button>
                        </div>
                    </div>
                </div>
            `;
            modalBody.innerHTML += resultHTML;
        });

        const finalScaledScore = (totalScore / examState.questions.length).toFixed(2);
        finalTotalScoreEl.textContent = finalScaledScore;

        questionSelectionArea.classList.add('hidden');
        examContent.classList.add('hidden');
        finalResultModal.classList.remove('hidden');

        fetch("{% url 'complete_session' %}", {
            method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ session_id: elements.sessionId })
        }).then(res => res.json()).then(data => console.log('Đã đánh dấu hoàn thành bài thi.'));
    };

    const handleQuestionAnswered = (resultData) => {
        const question = examState.questions.find(q => q.id === examState.currentQuestion.id);
        question.answered = true;
        question.result = resultData;
        examState.answeredCount++;

        const answeredButton = questionListContainer.querySelector(`[data-question-id="${question.id}"]`);
        answeredButton.disabled = true;
        answeredButton.classList.add('bg-green-100', 'border-green-500', 'cursor-not-allowed', 'opacity-60');
        if (!answeredButton.querySelector('.fa-check-circle')) {
            answeredButton.innerHTML += '<i class="fas fa-check-circle text-green-500 ml-auto absolute right-6 top-1/2 -translate-y-1/2"></i>';
        }

        fetch("{% url 'save_result' %}", {
            method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({...resultData, session_id: elements.sessionId})
        })
        .then(response => response.json())
        .then(apiResponse => {
            if (apiResponse.status === 'success') {
                console.log(`Kết quả câu ${question.id} đã được lưu!`);
                question.resultId = apiResponse.exam_result_id;
            } else {
                console.error(`Lỗi khi lưu kết quả câu ${question.id}:`, apiResponse.message);
            }
        });

        if (examState.answeredCount === examState.questions.length) {
            showFinalResults();
        } else {
            examContent.classList.add('hidden');
            questionSelectionArea.classList.remove('hidden');
        }
    };

    const startMainTimer = () => {
        let timeLeft = TOTAL_EXAM_DURATION;
        elements.mainTimer.textContent = formatTime(timeLeft);
        mainTimerInterval = setInterval(() => {
            timeLeft--;
            elements.mainTimer.textContent = formatTime(timeLeft);
            if (timeLeft <= 0) {
                clearInterval(mainTimerInterval);
                alert("Đã hết giờ làm bài!");
                document.querySelectorAll('.question-choice-btn:not(:disabled)').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                showFinalResults();
            }
        }, 1000);
    };

    const startRecording = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
            const wsPath = `${wsScheme}://${window.location.host}/ws/exam/${elements.subjectCode}/?question_id=${examState.currentQuestion.id}`;
            socket = new WebSocket(wsPath);

            socket.onopen = () => {
                updateUIState('recordingArea');
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) socket.send(event.data);
                };
                mediaRecorder.start(1000);
            };

            socket.onmessage = event => {
                const message = JSON.parse(event.data);
                if (message.type === 'result') {
                    handleQuestionAnswered(message.data || {});
                }
            };
            socket.onclose = () => console.log("WebSocket disconnected.");
            socket.onerror = (error) => console.error("WebSocket Error:", error);
        } catch (err) {
            console.error("Lỗi khi bắt đầu ghi âm:", err);
            alert("Không thể truy cập microphone. Vui lòng cấp quyền và thử lại.");
        }
    };

    const stopRecording = () => {
        if (mediaRecorder?.state === 'recording') mediaRecorder.stop();
        if (socket?.readyState === WebSocket.OPEN) socket.send(JSON.stringify({ 'type': 'end_of_stream' }));
        updateUIState('gradingArea');
    };

    // === GÁN SỰ KIỆN BAN ĐẦU ===

    questionListContainer.addEventListener('click', (event) => {
        const button = event.target.closest('.question-choice-btn');
        if (!button || button.disabled) return;

        const questionId = button.dataset.questionId;
        examState.currentQuestion = examState.questions.find(q => q.id === questionId);

        elements.questionText.textContent = examState.currentQuestion.text;
        questionSelectionArea.classList.add('hidden');
        examContent.classList.remove('hidden');
        updateUIState('interactionArea');
    });

    elements.startBtn.addEventListener('click', startRecording);
    elements.stopBtn.addEventListener('click', stopRecording);

    elements.backToSelectionBtn.addEventListener('click', () => {
        examContent.classList.add('hidden');
        questionSelectionArea.classList.remove('hidden');
        examState.currentQuestion = null;
    });

    elements.finishExamBtn.addEventListener('click', () => {
        confirmFinishModal.classList.remove('hidden');
    });

    elements.cancelFinishBtn.addEventListener('click', () => {
        confirmFinishModal.classList.add('hidden');
    });

    elements.confirmFinishBtn.addEventListener('click', () => {
        confirmFinishModal.classList.add('hidden');
        showFinalResults();
    });

    // CẢI TIẾN: Xóa trạng thái đã lưu khi người dùng hoàn thành và rời khỏi trang.
    elements.completeExamBtn.addEventListener('click', () => {
        sessionStorage.removeItem('examState');
        sessionStorage.removeItem('showResultsModal');
    });

    // === KHỞI TẠO TRANG ===

    // Bắt đầu đếm giờ
    startMainTimer();

    // CẢI TIẾN: Kiểm tra cờ trong sessionStorage khi trang tải.
    // Nếu người dùng vừa quay lại từ trang chi tiết, hiển thị lại modal kết quả.
    if (sessionStorage.getItem('showResultsModal') === 'true') {
        // Đồng bộ lại giao diện các nút câu hỏi dựa trên trạng thái đã lưu
        examState.questions.forEach(q => {
            if (q.answered) {
                const answeredButton = questionListContainer.querySelector(`[data-question-id="${q.id}"]`);
                if (answeredButton) {
                    answeredButton.disabled = true;
                    answeredButton.classList.add('bg-green-100', 'border-green-500', 'cursor-not-allowed', 'opacity-60');
                    if (!answeredButton.querySelector('.fa-check-circle')) {
                       answeredButton.innerHTML += '<i class="fas fa-check-circle text-green-500 ml-auto absolute right-6 top-1/2 -translate-y-1/2"></i>';
                    }
                }
            }
        });
        showFinalResults();
    }
});
</script>
{% endblock %}