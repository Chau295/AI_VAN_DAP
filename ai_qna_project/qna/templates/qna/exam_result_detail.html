{% extends 'base.html' %}
{% load static %}

{% block title %}Bài thi: {{ subject.name }}{% endblock %}

{% block content %}
<div id="exam-container" class="h-full">
  <!-- KHU BỐC THĂM / CHỌN CÂU HỎI -->
  <div id="question-selection-area">
    <div class="bg-white p-8 rounded-xl shadow-md max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <div>
          <h2 class="text-3xl font-bold text-gray-800">Bốc thăm câu hỏi</h2>
          <p class="text-gray-500">Vui lòng chọn lần lượt các câu hỏi để trả lời.</p>
        </div>
        <div>
          <h3 class="text-md font-semibold text-gray-700 text-right">Tổng thời gian còn lại</h3>
          <div id="main-timer" class="mt-1 text-3xl font-mono bg-red-100 text-red-700 text-center py-2 px-4 rounded-lg">15:00</div>
        </div>
      </div>

      <div id="question-list" class="space-y-4">
        {% for question in selected_questions %}
        <button
          class="question-choice-btn w-full text-left p-6 bg-gray-50 rounded-lg border-2 border-transparent hover:border-blue-500 hover:bg-blue-50 transition-all focus:outline-none"
          data-question-id="{{ question.id }}"
          data-barem-id="{{ question.question_id_in_barem }}"
          data-question-text="{{ question.question_text }}">
          <span class="font-semibold text-lg text-gray-800">Câu hỏi {{ forloop.counter }}:</span>
          <p class="text-gray-600 mt-1">{{ question.question_text }}</p>
        </button>
        {% endfor %}
      </div>

      <div class="mt-8 pt-6 border-t flex justify-end items-center">
        <button id="finish-exam-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
          <i class="fas fa-flag-checkered mr-2"></i>Kết thúc bài thi
        </button>
      </div>
    </div>
  </div>

  <!-- KHU TRẢ LỜI -->
  <div id="answer-area" class="h-full hidden">
    <div class="bg-white shadow-2xl rounded-2xl flex flex-col md:flex-row overflow-hidden h-full">
      <div class="w-full md:w-2/5 bg-gray-50 border-r border-gray-200 p-6 flex flex-col">
        <h2 id="answer-area-title" class="text-xl font-bold text-gray-800">Bài thi: {{ subject.name }}</h2>
        <p id="answer-area-question" class="mt-2 text-gray-600 bg-gray-100 p-4 rounded-lg min-h-[100px]"></p>
        <div class="flex-shrink-0 mt-auto pt-6">
          <button id="back-to-selection-btn" class="w-full text-center block bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Quay về danh sách
          </button>
        </div>
      </div>

      <div class="w-full md:w-3/5 p-8 flex flex-col items-center justify-center text-center bg-white">
        <div id="interaction-state">
          <i class="fas fa-microphone-alt text-5xl text-gray-300"></i>
          <h2 class="text-2xl font-bold text-gray-800 mt-4">Sẵn sàng trả lời</h2>
          <p class="text-gray-500 mt-2">Nhấn nút bên dưới để bắt đầu ghi âm.</p>
          <button id="start-recording-btn" class="mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-all text-lg shadow-lg">
            <i class="fas fa-play mr-2"></i> Bắt đầu
          </button>
        </div>

        <div id="recording-state" class="hidden w-full">
          <h2 class="text-2xl font-bold text-blue-600 mt-4">Đang ghi âm...</h2>
          <p class="text-gray-500 mt-2">Hãy nói rõ ràng. Nhấn Dừng để nộp bài.</p>
          <button id="stop-recording-btn" class="mt-8 bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition-all text-lg shadow-lg">
            <i class="fas fa-stop mr-2"></i> Dừng & Nộp bài
          </button>
        </div>

        <div id="grading-state" class="hidden">
          <i class="fas fa-spinner fa-spin text-5xl text-gray-400"></i>
          <h2 class="text-2xl font-bold text-gray-800 mt-4">Đang chấm điểm...</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Sticky countdown cho phần phụ -->
  <div id="suppSticky" style="display:none; position:fixed; right:16px; bottom:16px; z-index:9998;">
    <div style="background:#111827; color:#fff; padding:8px 12px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2)">
      Câu hỏi phụ còn: <span id="suppStickyTimer" class="font-mono font-bold">06:00</span>
    </div>
  </div>

  <!-- MODAL: Tổng kết phần chính -->
  <div id="summaryModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:560px">
      <h3 class="text-2xl font-semibold text-gray-800 mb-1">Kết quả phần thi chính</h3>
      <p class="text-gray-600 mb-2">Điểm trung bình hiện tại của bạn là:</p>
      <div id="summaryScore" class="text-blue-600" style="font-size:3rem;font-weight:800;margin-bottom:8px">0.00</div>
      <div id="summaryNote" style="margin-bottom:12px;color:#555"></div>

      <div id="suppCountdownWrap" style="display:none;margin:8px 0 12px;padding:8px;border-radius:8px;background:#f7f7f7;">
        <div class="font-semibold mb-1">Thời gian thi câu hỏi phụ</div>
        <div id="suppCountdown" style="font-size:20px;font-weight:700">06:00</div>
      </div>

      <div class="mt-6 pt-4 border-t flex gap-2 justify-end">
        <!-- Nút Thoát: lưu lịch sử & rời trang -->
        <button id="btnSummaryExit" class="btn">Thoát</button>
        <button id="btnStartSupp" class="btn btn-primary" style="display:none;">Bắt đầu thi câu hỏi phụ</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Kết quả chi tiết + phúc khảo (layout giống file bạn đưa) -->
  <div id="finalResultModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:860px">
      <h3 class="text-2xl font-semibold text-gray-800 mb-3">Kết quả bài thi chi tiết</h3>

      <div class="flex items-center gap-4 mb-4">
        <div>
          <span class="text-lg font-semibold text-gray-700">Tổng điểm cuối cùng:</span>
          <span id="finalTotalScore" class="text-blue-600" style="font-size:2.5rem;font-weight:800">0.00</span>
        </div>
        <div id="appealTimer" class="ml-auto bg-indigo-50 px-3 py-1.5 rounded-lg">
          Phúc khảo còn: <span id="appealCountdown" class="font-mono font-bold">06:00</span>
        </div>
      </div>

      <div class="space-y-6">
        <section>
          <h4 class="text-xl font-semibold text-gray-800 mb-2">Phần câu hỏi chính</h4>
          <div id="detailMain" class="divide-y divide-gray-200"></div>
        </section>

        <section id="detailSuppWrap" style="display:none;">
          <h4 class="text-xl font-semibold text-gray-800 mb-2">Phần câu hỏi phụ</h4>
          <div id="detailSupp" class="divide-y divide-gray-200"></div>
        </section>
      </div>

      <div class="mt-6 pt-4 border-t text-right flex gap-2 justify-end">
        <button class="btn" id="btnCloseFinal">Đóng</button>
        <!-- Nút Hoàn thành: lưu lịch sử & rời trang -->
        <button class="btn btn-primary" id="btnFinishAndExit">Hoàn thành</button>
      </div>
    </div>
  </div>
</div>

{{ session.id|json_script:"session_id_data" }}
{% csrf_token %}

<style>
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal-content{background:#fff;border-radius:12px;padding:24px 28px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  .btn{padding:8px 16px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:600}
  .btn:hover{background:#f6f6f6}
  .btn-primary{border-color:#306bff;background:#306bff;color:#fff}
</style>
{% endblock %}

{% block extra_js %}
<script>window.__BAREM__ = {{ barem_json|safe|default:"[]" }};</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  /** ====== Config / URLs / State ====== */
  const MAIN_DURATION_MS = 15 * 60 * 1000;    // 15'
  const APPEAL_WINDOW_MS = 6  * 60 * 1000;    // 6'
  const SUPP_WINDOW_MS   = 6  * 60 * 1000;    // 6'

  const COMPLETE_URL = "{% url 'complete_exam_session' %}";
  const HISTORY_URL  = "{% url 'history' %}";
  const CSRF = document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';

  const elements = {
    sessionId: JSON.parse(document.getElementById('session_id_data').textContent),
    selection: document.getElementById('question-selection-area'),
    answer: document.getElementById('answer-area'),
    backBtn: document.getElementById('back-to-selection-btn'),
    startBtn: document.getElementById('start-recording-btn'),
    stopBtn: document.getElementById('stop-recording-btn'),
    interaction: document.getElementById('interaction-state'),
    recording: document.getElementById('recording-state'),
    grading: document.getElementById('grading-state'),
    aTitle: document.getElementById('answer-area-title'),
    aQuestion: document.getElementById('answer-area-question'),
  };

  const examState = { questions: [], currentQuestion: null };
  const state = {
    mainResults: [],             // {question_id, barem_id, score, transcript, feedback, text}
    suppResults: [],             // {question_text, score, max_score, feedback}
    totalScoreMain: 0,
    totalScoreFinal: 0,
    suppDeadline: null,
    appealDeadline: null,
    suppInProgress: false,
    suppQueue: [],               // [{id, question_text}]
    currentSuppIndex: -1,
    eachSuppMax: 0,
  };

  // build questions from DOM
  document.querySelectorAll('.question-choice-btn').forEach(btn => {
    examState.questions.push({
      id: Number(btn.dataset.questionId),
      barem_id: btn.dataset.baremId ? String(btn.dataset.baremId) : null,
      question_text: btn.dataset.questionText
    });
  });

  /** ====== Utils ====== */
  function modalShow(id){ document.getElementById(id).style.display='flex'; }
  function modalHide(id){ document.getElementById(id).style.display='none'; }
  function fmt(n){ return (Math.round(Number(n||0)*100)/100).toFixed(2); }
  function mmss(ms){ const s=Math.max(0,Math.ceil(ms/1000)); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
  function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

  /** ====== Main timer ====== */
  let mainTimerEnd=null, mainTimerItv=null;
  function startMainTimer(ms=MAIN_DURATION_MS){
    mainTimerEnd = Date.now() + ms;
    clearInterval(mainTimerItv);
    const el = document.getElementById('main-timer');
    const tick = () => {
      const left = Math.max(0, mainTimerEnd - Date.now());
      el.textContent = mmss(left);
      if (left<=0){ clearInterval(mainTimerItv); onFinishMainExam(); }
    };
    mainTimerItv = setInterval(tick, 250); tick();
  }

  /** ====== Supp countdown (modal + sticky) ====== */
  let suppItv=null, appealItv=null;
  function startSuppCountdown(){
    stopSuppCountdown();
    document.getElementById('suppCountdownWrap').style.display = 'block';
    document.getElementById('suppSticky').style.display = 'block';
    suppItv = setInterval(()=>{
      const left = state.suppDeadline - Date.now();
      document.getElementById('suppCountdown').textContent = mmss(left);
      document.getElementById('suppStickyTimer').textContent = mmss(left);
      if (left<=0){ finalizeAndShowResult(); }
    }, 250);
  }
  function stopSuppCountdown(){ if(suppItv){ clearInterval(suppItv); suppItv=null; } }

  function startAppealCountdown(){
    stopAppealCountdown();
    state.appealDeadline = Date.now() + APPEAL_WINDOW_MS;
    appealItv = setInterval(()=>{
      const left = state.appealDeadline - Date.now();
      document.getElementById('appealCountdown').textContent = mmss(left);
      if(left<=0) stopAppealCountdown();
    }, 250);
  }
  function stopAppealCountdown(){ if(appealItv){ clearInterval(appealItv); appealItv=null; } }

  /** ====== Screen / UI ====== */
  function showScreen(name){
    elements.selection.style.display = 'none';
    elements.answer.style.display = 'none';
    if (name==='selection') elements.selection.style.display = 'block';
    if (name==='answer')    elements.answer.style.display = 'block';
  }
  function setAnswerUI(which){
    ['interaction','recording','grading'].forEach(k => elements[k].style.display='none');
    elements[which].style.display='block';
  }
  function startAnswering(questionData, type, idx=-1){
    examState.currentQuestion = { ...questionData, type };
    if (type==='supplementary'){
      state.currentSuppIndex = idx;
      elements.aTitle.textContent = `Câu hỏi phụ ${idx+1}`;
      elements.backBtn.style.display = 'none';
    } else {
      elements.aTitle.textContent = 'Câu hỏi chính';
      elements.backBtn.style.display = 'block';
    }
    elements.aQuestion.textContent = questionData.question_text;
    setAnswerUI('interaction');
    showScreen('answer');
  }

  /** ====== WebSocket + Audio ====== */
  let socket, mediaRecorder, chunks=[];
  function connectWS(){
    const wsScheme = location.protocol==='https:' ? 'wss' : 'ws';
    socket = new WebSocket(`${wsScheme}://${location.host}/ws/exam/{{ session.id }}/`);
    socket.binaryType = "arraybuffer";

    socket.onopen = () => console.log('WS connected');
    socket.onmessage = evt => {
      try{
        const m = JSON.parse(evt.data);
        if(m.type==='exam.result' && m.message) handleExamResult(m.message);
        else if(m.type==='exam.error') { alert(m.message||'Lỗi'); setAnswerUI('interaction'); }
      }catch(e){ /* ignore */ }
    };
    socket.onclose = () => console.log('WS closed');
  }

  async function startRecording(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
      });
      chunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType:'audio/webm;codecs=opus' });
      mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type:'audio/webm;codecs=opus' });
        if(examState.currentQuestion?.type==='supplementary') submitSupp(blob);
        else submitMain(blob);
        stream.getTracks().forEach(t=>t.stop());
      };
      setAnswerUI('recording');
      mediaRecorder.start();
    }catch(e){
      alert('Không thể truy cập micro');
    }
  }
  function stopRecording(){
    if(mediaRecorder?.state==='recording') mediaRecorder.stop();
    setAnswerUI('grading');
  }

  async function submitMain(blob){
    if(!socket || socket.readyState!==WebSocket.OPEN) return;
    socket.send(JSON.stringify({ type:'asr.stream.start', session_id: elements.sessionId }));
    socket.send(await blob.arrayBuffer());
    socket.send(JSON.stringify({
      type:'asr.stream.end',
      mode:'main',
      process_type:'main',
      session_id: elements.sessionId,
      question_id: examState.currentQuestion.id
    }));
  }
  async function submitSupp(blob){
    if(!socket || socket.readyState!==WebSocket.OPEN) return;
    const q = state.suppQueue[state.currentSuppIndex];
    socket.send(JSON.stringify({ type:'asr.stream.start', session_id: elements.sessionId }));
    socket.send(await blob.arrayBuffer());
    socket.send(JSON.stringify({
      type:'asr.stream.end',
      mode:'supplementary',
      process_type:'supplementary',
      session_id: elements.sessionId,
      question_text: q.question_text,
      max_score: state.eachSuppMax
    }));
  }

  /** ====== Handle server results ====== */
  function handleExamResult(payload){
    const d = payload.data || {};
    if(payload.type==='main_question_complete'){
      if(!state.mainResults.find(r=>r.question_id==d.question_id)){
        const btn = document.querySelector(`[data-question-id="${d.question_id}"]`);
        if(btn){ btn.classList.add('opacity-60','pointer-events-none'); }
        const baremId = examState.questions.find(q=>q.id===d.question_id)?.barem_id || null;
        state.mainResults.push({
          question_id: d.question_id,
          barem_id: baremId,
          score: d.score,
          transcript: d.transcript,
          feedback: d.feedback,
          text: document.querySelector(`[data-question-id="${d.question_id}"] p`)?.textContent || ''
        });
      }
      showScreen('selection');
      setAnswerUI('interaction');
    }
    if(payload.type==='supp_question_complete'){
      state.suppResults.push({
        question_text: d.question_text, score: d.score, max_score: d.max_score, feedback: d.feedback
      });
      const next = state.currentSuppIndex + 1;
      if(next < state.suppQueue.length){
        startAnswering(state.suppQueue[next], 'supplementary', next);
      }else{
        finalizeAndShowResult();
      }
    }
  }

  /** ====== Finish main exam ====== */
  function onFinishMainExam(){
    if(state.mainResults.length===0){
      alert('Bạn chưa trả lời câu hỏi nào.');
      return;
    }
    state.totalScoreMain = state.mainResults.reduce((s,r)=>s+(Number(r.score)||0), 0) / state.mainResults.length;
    state.suppDeadline = Date.now() + SUPP_WINDOW_MS;

    document.getElementById('summaryScore').textContent = fmt(state.totalScoreMain);
    const note = document.getElementById('summaryNote');
    const btnSupp = document.getElementById('btnStartSupp');
    const btnExit = document.getElementById('btnSummaryExit');

    // "Thoát" ở đây sẽ LƯU LỊCH SỬ + RỜI TRANG
    btnExit.onclick = finishAndExit;

    if(state.totalScoreMain >= 7){
      note.textContent = 'Điểm đạt yêu cầu. Bạn có thể thoát và xem lại trong Lịch sử thi (phúc khảo 6 phút).';
      btnSupp.style.display = 'none';
      document.getElementById('suppCountdownWrap').style.display='none';
    }else{
      const need = Math.max(0, 7 - state.totalScoreMain);
      state.eachSuppMax = need / 2;
      note.innerHTML = `Điểm chưa đạt. Bạn có <b>2 câu hỏi phụ</b>. Mỗi câu tối đa <b>${fmt(state.eachSuppMax)}</b> điểm. Hoặc bấm <b>Thoát</b> để kết thúc.`;
      btnSupp.style.display = 'inline-block';
      btnSupp.onclick = () => { modalHide('summaryModal'); startSuppExam(); };
      startSuppCountdown();
    }
    modalShow('summaryModal');
  }

  /** ====== Supplementary flow ====== */
  function pickSupp(){
    const pool = Array.isArray(window.__BAREM__)? window.__BAREM__ : [];
    // loại trừ theo barem_id của câu chính đã trả lời
    const usedBarem = new Set(state.mainResults.map(r=>String(r.barem_id||'')));
    const candidates = pool.filter(b=> !usedBarem.has(String(b.id)));
    return shuffle(candidates).slice(0,2).map(b=>({ id:b.id, question_text:b.question }));
  }
  function startSuppExam(){
    state.suppInProgress = true;
    state.suppQueue = pickSupp();
    state.suppResults = [];
    document.getElementById('suppSticky').style.display = 'block';
    if(state.suppQueue.length===0){
      alert('Không có câu hỏi phụ phù hợp.');
      finalizeAndShowResult();
      return;
    }
    startAnswering(state.suppQueue[0], 'supplementary', 0);
  }

  function finalizeAndShowResult(){
    stopSuppCountdown();
    document.getElementById('suppSticky').style.display = 'none';
    const extra = state.suppResults.reduce((s,r)=>s+(Number(r.score)||0),0);
    state.totalScoreFinal = state.totalScoreMain + extra;
    showFinal(true);
  }

  function showFinal(includeSupp){
    // render main
    document.getElementById('detailMain').innerHTML = state.mainResults.map((r,i)=>`
      <div class="py-3">
        <div class="font-semibold">Câu ${i+1}: <span class="font-normal">${r.text || ''}</span></div>
        <div class="mt-1">Điểm: <b>${fmt(r.score)}</b> / 10.00</div>
        ${r.feedback ? `<div class="text-gray-600 mt-1">Phản hồi: ${r.feedback}</div>`:''}
      </div>`).join('');

    // render supp
    const wrap = document.getElementById('detailSuppWrap');
    if(includeSupp && state.suppResults.length){
      wrap.style.display = 'block';
      document.getElementById('detailSupp').innerHTML = state.suppResults.map((r,i)=>`
        <div class="py-3">
          <div class="font-semibold">Câu phụ ${i+1}: <span class="font-normal">${r.question_text||''}</span></div>
          <div class="mt-1">Điểm cộng thêm: <b>+${fmt(r.score)}</b> / ${fmt(r.max_score || state.eachSuppMax)}</div>
          ${r.feedback ? `<div class="text-gray-600 mt-1">Phản hồi: ${r.feedback}</div>`:''}
        </div>`).join('');
    }else{
      wrap.style.display='none';
    }

    document.getElementById('finalTotalScore').textContent = fmt(Math.min(10, includeSupp?state.totalScoreFinal:state.totalScoreMain));
    startAppealCountdown();
    modalShow('finalResultModal');
  }

  /** ====== Finish & Exit (lưu lịch sử) ====== */
  async function finishAndExit(){
    try {
      await fetch(COMPLETE_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'X-CSRFToken': CSRF },
        body: JSON.stringify({ session_id: elements.sessionId })
      });
    } catch (e) {
      console.warn('complete_exam_session failed:', e);
    } finally {
      window.location.href = HISTORY_URL;
    }
  }

  /** ====== Bind events ====== */
  // chọn câu hỏi
  document.querySelectorAll('.question-choice-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(btn.classList.contains('pointer-events-none')) return;
      const q = {
        id:Number(btn.dataset.questionId),
        barem_id: btn.dataset.baremId ? String(btn.dataset.baremId) : null,
        question_text: btn.dataset.questionText
      };
      startAnswering(q, 'main');
    });
  });

  // điều khiển ghi âm
  elements.backBtn.addEventListener('click', ()=>showScreen('selection'));
  elements.startBtn.addEventListener('click', startRecording);
  elements.stopBtn.addEventListener('click', stopRecording);

  // kết thúc phần chính
  document.getElementById('finish-exam-btn').addEventListener('click', onFinishMainExam);

  // modal kết quả chi tiết
  document.getElementById('btnCloseFinal').onclick = () => modalHide('finalResultModal');
  document.getElementById('btnFinishAndExit').onclick = finishAndExit;

  // Kết nối WS + khởi động timer
  connectWS();
  startMainTimer();
});
</script>
{% endblock %}
