{% extends 'base.html' %}
{% load static %}
{% block title %}Lịch sử thi{% endblock %}

{% block content %}
<div id="history-content">
    <h2 class="text-3xl font-bold text-gray-800 mb-8">Lịch sử các bài thi</h2>
    <div class="bg-white p-6 rounded-xl shadow-md">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Môn học</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày thi</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điểm trung bình</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for session in sessions %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ session.subject.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ session.completed_at|date:"d/m/Y H:i" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold {% if session.calculate_average_score >= 5 %}text-green-600{% else %}text-red-600{% endif %}">
                            {{ session.calculate_average_score|floatformat:2 }} / 10
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center">
                            <button class="view-session-detail-btn text-blue-600 hover:text-blue-900" data-session-id="{{ session.id }}">Xem chi tiết</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">Bạn chưa có lịch sử bài thi nào.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="session-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="p-6 border-b">
            <h2 id="session-modal-title" class="text-2xl font-bold text-gray-800">Kết quả bài thi</h2>
        </div>
        <div id="session-modal-body" class="p-6 space-y-4 overflow-y-auto"></div>
        <div class="p-6 border-t bg-gray-50 rounded-b-xl flex justify-between items-center">
             <div>
                <span class="text-lg font-semibold text-gray-700">Tổng điểm cuối cùng:</span>
                <span id="session-total-score" class="text-3xl font-bold text-blue-600"></span>
                <span class="text-gray-600">/ 10</span>
             </div>
            <button id="close-session-modal-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Đóng</button>
        </div>
    </div>
</div>

<div id="result-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-800">Chi tiết câu trả lời</h2>
            <button id="back-to-session-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
        </div>
        <div id="result-modal-body" class="p-6 space-y-4 overflow-y-auto"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const sessionDetailModal = document.getElementById('session-detail-modal');
    const resultDetailModal = document.getElementById('result-detail-modal');
    const sessionModalBody = document.getElementById('session-modal-body');

    // === Xử lý mở Modal chi tiết phiên thi ===
    document.querySelectorAll('.view-session-detail-btn').forEach(button => {
        button.addEventListener('click', async () => {
            const sessionId = button.dataset.sessionId;
            const response = await fetch(`/api/history/session/${sessionId}/`);
            const data = await response.json();

            document.getElementById('session-modal-title').textContent = `Kết quả bài thi: ${data.subject_name}`;
            document.getElementById('session-total-score').textContent = data.average_score;

            sessionModalBody.innerHTML = '';
            data.detailed_questions.forEach((q, index) => {
                let actionButtonsHTML = '';
                if (q.result_id) {
                    actionButtonsHTML += `<button class="view-result-detail-btn text-sm text-blue-600 hover:underline" data-result-id="${q.result_id}">Xem chi tiết</button>`;
                    if (data.is_re_evaluation_allowed) {
                        actionButtonsHTML += `<button class="text-sm text-indigo-600 hover:underline">Xin phúc khảo</button>`;
                    }
                } else {
                    actionButtonsHTML = '<span class="text-sm text-gray-500 italic">Chưa trả lời</span>';
                }

                const resultHTML = `
                    <div class="p-4 border rounded-lg">
                        <p class="font-semibold text-gray-800">Câu ${index + 1}: ${q.question_text}</p>
                        <div class="mt-3 flex justify-between items-center">
                            <p class="font-bold text-lg">Điểm: <span class="text-blue-600">${q.score.toFixed(2)}/10</span></p>
                            <div class="space-x-4">
                                ${actionButtonsHTML}
                            </div>
                        </div>
                    </div>
                `;
                sessionModalBody.innerHTML += resultHTML;
            });
            sessionDetailModal.classList.remove('hidden');
        });
    });

    // === Xử lý mở Modal chi tiết câu trả lời (dùng Event Delegation) ===
    sessionModalBody.addEventListener('click', async (event) => {
        if (event.target.classList.contains('view-result-detail-btn')) {
            const resultId = event.target.dataset.resultId;
            const response = await fetch(`/api/history/result/${resultId}/`);
            const data = await response.json();

            let analysisHTML = (data.analysis || []).map(item =>
                `<li class="flex items-center text-gray-700">${item.matched ? '<i class="fas fa-check-circle text-green-500 w-5 mr-2"></i>' : '<i class="fas fa-times-circle text-red-500 w-5 mr-2"></i>'}<span>${item.text}</span></li>`
            ).join('');

            const modalBody = document.getElementById('result-modal-body');
            modalBody.innerHTML = `
                <div><h3 class="font-semibold">Câu hỏi</h3><p class="bg-gray-100 p-3 rounded">${data.question_text}</p></div>
                <div><h3 class="font-semibold">Câu trả lời</h3><p class="bg-gray-100 p-3 rounded italic">"${data.transcript}"</p></div>
                <div><h3 class="font-semibold">Phân tích AI</h3><ul class="p-3 bg-gray-50 rounded">${analysisHTML}</ul></div>
                <div><h3 class="font-semibold">Nhận xét</h3><p class="bg-yellow-100 p-3 rounded">${data.feedback}</p></div>
                <div><h3 class="font-semibold">Điểm</h3><p class="text-2xl font-bold text-blue-600">${data.score}/10</p></div>
            `;

            sessionDetailModal.classList.add('hidden');
            resultDetailModal.classList.remove('hidden');
        }
    });

    // === Xử lý đóng các Modal ===
    document.getElementById('close-session-modal-btn').addEventListener('click', () => {
        sessionDetailModal.classList.add('hidden');
    });

    document.getElementById('back-to-session-modal-btn').addEventListener('click', () => {
        resultDetailModal.classList.add('hidden');
        sessionDetailModal.classList.remove('hidden');
    });
});
</script>
{% endblock %}